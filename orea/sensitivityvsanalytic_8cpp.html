<!-- HTML header for doxygen 1.8.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<title>OREAnalytics: test/sensitivityvsanalytic.cpp File Reference</title>
<link href="https://fonts.googleapis.com/css?family=Merriweather+Sans|Open+Sans" rel="stylesheet">
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" type="image/png" href="favicon.png">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="oreaextra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
   <div id="projectname"><a href="https://rkapl123.github.io/OREAnnotatedSource/">
       <img src="logo-analytics@2x.png" alt="Logo" width="150" height="68" style="float: left; padding: 15px;"/></a>
   <div id="projectbrief">Fully annotated reference manual - version 1.8.12</div>
   </div>
</div>
<!-- end header part --><!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_13e138d54eb8818da29c3992edef070a.html">test</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">sensitivityvsanalytic.cpp File Reference</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;oret/toplevelfixture.hpp&gt;</code><br />
<code>#include &lt;<a class="el" href="oreatoplevelfixture_8hpp_source.html">test/oreatoplevelfixture.hpp</a>&gt;</code><br />
<code>#include &quot;<a class="el" href="testmarket_8hpp_source.html">testmarket.hpp</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="testportfolio_8hpp_source.html">testportfolio.hpp</a>&quot;</code><br />
<code>#include &lt;<a class="el" href="deltascenariofactory_8hpp_source.html">orea/scenario/deltascenariofactory.hpp</a>&gt;</code><br />
<code>#include &lt;qle/pricingengines/analyticeuropeanenginedeltagamma.hpp&gt;</code><br />
<code>#include &lt;qle/pricingengines/blackswaptionenginedeltagamma.hpp&gt;</code><br />
<code>#include &lt;qle/pricingengines/discountingswapenginedeltagamma.hpp&gt;</code><br />
<code>#include &lt;<a class="el" href="inmemorycube_8hpp_source.html">orea/cube/inmemorycube.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="npvcube_8hpp_source.html">orea/cube/npvcube.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="filteredsensitivitystream_8hpp_source.html">orea/engine/filteredsensitivitystream.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="observationmode_8hpp_source.html">orea/engine/observationmode.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="parametricvar_8hpp_source.html">orea/engine/parametricvar.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="riskfilter_8hpp_source.html">orea/engine/riskfilter.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="sensitivityaggregator_8hpp_source.html">orea/engine/sensitivityaggregator.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="sensitivityanalysis_8hpp_source.html">orea/engine/sensitivityanalysis.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="sensitivitycubestream_8hpp_source.html">orea/engine/sensitivitycubestream.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="sensitivityfilestream_8hpp_source.html">orea/engine/sensitivityfilestream.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="sensitivityinmemorystream_8hpp_source.html">orea/engine/sensitivityinmemorystream.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="sensitivityrecord_8hpp_source.html">orea/engine/sensitivityrecord.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="sensitivitystream_8hpp_source.html">orea/engine/sensitivitystream.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="stresstest_8hpp_source.html">orea/engine/stresstest.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="valuationcalculator_8hpp_source.html">orea/engine/valuationcalculator.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="valuationengine_8hpp_source.html">orea/engine/valuationengine.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="scenariosimmarket_8hpp_source.html">orea/scenario/scenariosimmarket.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="scenariosimmarketparameters_8hpp_source.html">orea/scenario/scenariosimmarketparameters.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="sensitivityscenariodata_8hpp_source.html">orea/scenario/sensitivityscenariodata.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="sensitivityscenariogenerator_8hpp_source.html">orea/scenario/sensitivityscenariogenerator.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="elRef" href="../ored/lgmdata_8hpp.html">ored/model/lgmdata.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="elRef" href="../ored/builders_2capfloor_8hpp.html">ored/portfolio/builders/capfloor.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="elRef" href="../ored/builders_2fxforward_8hpp.html">ored/portfolio/builders/fxforward.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="elRef" href="../ored/builders_2fxoption_8hpp.html">ored/portfolio/builders/fxoption.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="elRef" href="../ored/builders_2swap_8hpp.html">ored/portfolio/builders/swap.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="elRef" href="../ored/builders_2swaption_8hpp.html">ored/portfolio/builders/swaption.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="elRef" href="../ored/fxoption_8hpp.html">ored/portfolio/fxoption.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="elRef" href="../ored/portfolio_8hpp.html">ored/portfolio/portfolio.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="elRef" href="../ored/swap_8hpp.html">ored/portfolio/swap.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="elRef" href="../ored/swaption_8hpp.html">ored/portfolio/swaption.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="elRef" href="../ored/log_8hpp.html">ored/utilities/log.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="elRef" href="../ored/osutils_8hpp.html">ored/utilities/osutils.hpp</a>&gt;</code><br />
<code>#include &lt;ql/math/randomnumbers/mt19937uniformrng.hpp&gt;</code><br />
<code>#include &lt;ql/time/calendars/target.hpp&gt;</code><br />
<code>#include &lt;ql/time/date.hpp&gt;</code><br />
<code>#include &lt;ql/time/daycounters/actualactual.hpp&gt;</code><br />
</div>
<p><a href="sensitivityvsanalytic_8cpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ae617b63114d8963eea782ae740c170d7"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sensitivityvsanalytic_8cpp.html#ae617b63114d8963eea782ae740c170d7">BOOST_AUTO_TEST_CASE</a> (testSensitivities)</td></tr>
<tr class="separator:ae617b63114d8963eea782ae740c170d7"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="ae617b63114d8963eea782ae740c170d7" name="ae617b63114d8963eea782ae740c170d7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae617b63114d8963eea782ae740c170d7">&#9670;&#160;</a></span>BOOST_AUTO_TEST_CASE()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">BOOST_AUTO_TEST_CASE </td>
          <td>(</td>
          <td class="paramtype">testSensitivities&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="sensitivityvsanalytic_8cpp_source.html#l00406">406</a> of file <a class="el" href="sensitivityvsanalytic_8cpp_source.html">sensitivityvsanalytic.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  406</span>                                        {</div>
<div class="line"><span class="lineno">  407</span> </div>
<div class="line"><span class="lineno">  408</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Checking sensitivity analysis results vs analytic sensi engine results...&quot;</span>);</div>
<div class="line"><span class="lineno">  409</span> </div>
<div class="line"><span class="lineno">  410</span>    SavedSettings backup;</div>
<div class="line"><span class="lineno">  411</span> </div>
<div class="line"><span class="lineno">  412</span>    <a class="code hl_enumeration" href="classore_1_1analytics_1_1_observation_mode.html#a46c8a310cf4c094f8c80e1cb8dc1f911">ObservationMode::Mode</a> backupMode = ObservationMode::instance().mode();</div>
<div class="line"><span class="lineno">  413</span>    ObservationMode::instance().setMode(ObservationMode::Mode::None);</div>
<div class="line"><span class="lineno">  414</span> </div>
<div class="line"><span class="lineno">  415</span>    Date today = Date(14, April, 2016); <span class="comment">// Settings::instance().evaluationDate();</span></div>
<div class="line"><span class="lineno">  416</span>    Settings::instance().evaluationDate() = today;</div>
<div class="line"><span class="lineno">  417</span> </div>
<div class="line"><span class="lineno">  418</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Today is &quot;</span> &lt;&lt; today);</div>
<div class="line"><span class="lineno">  419</span> </div>
<div class="line"><span class="lineno">  420</span>    <span class="comment">// Init market</span></div>
<div class="line"><span class="lineno">  421</span>    QuantLib::ext::shared_ptr&lt;Market&gt; initMarket = QuantLib::ext::make_shared&lt;testsuite::TestMarket&gt;(today);</div>
<div class="line"><span class="lineno">  422</span> </div>
<div class="line"><span class="lineno">  423</span>    <span class="comment">// build scenario sim market parameters</span></div>
<div class="line"><span class="lineno">  424</span>    QuantLib::ext::shared_ptr&lt;analytics::ScenarioSimMarketParameters&gt; simMarketData = <a class="code hl_function" href="test_2parsensitivityanalysis_8cpp.html#aa08bc8726d4f893388fcc254b42b9005">setupSimMarketData5</a>();</div>
<div class="line"><span class="lineno">  425</span> </div>
<div class="line"><span class="lineno">  426</span>    <span class="comment">// sensitivity config</span></div>
<div class="line"><span class="lineno">  427</span>    QuantLib::ext::shared_ptr&lt;SensitivityScenarioData&gt; sensiData = <a class="code hl_function" href="test_2parsensitivityanalysis_8cpp.html#a5fd42c03e26bc9fd3ade2213066b2ac9">setupSensitivityScenarioData5</a>(<span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">  428</span> </div>
<div class="line"><span class="lineno">  429</span>    <span class="comment">// build scenario sim market</span></div>
<div class="line"><span class="lineno">  430</span>    InstrumentConventions::instance().setConventions(conv());</div>
<div class="line"><span class="lineno">  431</span>    QuantLib::ext::shared_ptr&lt;analytics::ScenarioSimMarket&gt; simMarket =</div>
<div class="line"><span class="lineno">  432</span>        QuantLib::ext::make_shared&lt;analytics::ScenarioSimMarket&gt;(initMarket, simMarketData);</div>
<div class="line"><span class="lineno">  433</span> </div>
<div class="line"><span class="lineno">  434</span>    <span class="comment">// build scenario factory</span></div>
<div class="line"><span class="lineno">  435</span>    QuantLib::ext::shared_ptr&lt;Scenario&gt; baseScenario = simMarket-&gt;baseScenario();</div>
<div class="line"><span class="lineno">  436</span>    QuantLib::ext::shared_ptr&lt;ScenarioFactory&gt; scenarioFactory = QuantLib::ext::make_shared&lt;DeltaScenarioFactory&gt;(baseScenario);</div>
<div class="line"><span class="lineno">  437</span> </div>
<div class="line"><span class="lineno">  438</span>    <span class="comment">// build scenario generator</span></div>
<div class="line"><span class="lineno">  439</span>    QuantLib::ext::shared_ptr&lt;SensitivityScenarioGenerator&gt; scenarioGenerator =</div>
<div class="line"><span class="lineno">  440</span>        QuantLib::ext::make_shared&lt;SensitivityScenarioGenerator&gt;(sensiData, baseScenario, simMarketData, simMarket,</div>
<div class="line"><span class="lineno">  441</span>                                                         scenarioFactory, <span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">  442</span>    simMarket-&gt;scenarioGenerator() = scenarioGenerator;</div>
<div class="line"><span class="lineno">  443</span> </div>
<div class="line"><span class="lineno">  444</span>    <span class="comment">// build porfolio</span></div>
<div class="line"><span class="lineno">  445</span>    QuantLib::ext::shared_ptr&lt;EngineData&gt; <a class="code hl_variableRef" href="../ored/log_8hpp.html#a08cf33440c824c6fda734c566a726536a604ac82e88d7a367d4c2830411520c2b">data</a> = QuantLib::ext::make_shared&lt;EngineData&gt;();</div>
<div class="line"><span class="lineno">  446</span>    <a class="code hl_variableRef" href="../ored/log_8hpp.html#a08cf33440c824c6fda734c566a726536a604ac82e88d7a367d4c2830411520c2b">data</a>-&gt;model(<span class="stringliteral">&quot;Swap&quot;</span>) = <span class="stringliteral">&quot;DiscountedCashflows&quot;</span>;</div>
<div class="line"><span class="lineno">  447</span>    <a class="code hl_variableRef" href="../ored/log_8hpp.html#a08cf33440c824c6fda734c566a726536a604ac82e88d7a367d4c2830411520c2b">data</a>-&gt;engine(<span class="stringliteral">&quot;Swap&quot;</span>) = <span class="stringliteral">&quot;DiscountingSwapEngine&quot;</span>;</div>
<div class="line"><span class="lineno">  448</span>    <a class="code hl_variableRef" href="../ored/log_8hpp.html#a08cf33440c824c6fda734c566a726536a604ac82e88d7a367d4c2830411520c2b">data</a>-&gt;model(<span class="stringliteral">&quot;CrossCurrencySwap&quot;</span>) = <span class="stringliteral">&quot;DiscountedCashflows&quot;</span>;</div>
<div class="line"><span class="lineno">  449</span>    <a class="code hl_variableRef" href="../ored/log_8hpp.html#a08cf33440c824c6fda734c566a726536a604ac82e88d7a367d4c2830411520c2b">data</a>-&gt;engine(<span class="stringliteral">&quot;CrossCurrencySwap&quot;</span>) = <span class="stringliteral">&quot;DiscountingCrossCurrencySwapEngine&quot;</span>;</div>
<div class="line"><span class="lineno">  450</span>    <a class="code hl_variableRef" href="../ored/log_8hpp.html#a08cf33440c824c6fda734c566a726536a604ac82e88d7a367d4c2830411520c2b">data</a>-&gt;model(<span class="stringliteral">&quot;FxOption&quot;</span>) = <span class="stringliteral">&quot;GarmanKohlhagen&quot;</span>;</div>
<div class="line"><span class="lineno">  451</span>    <a class="code hl_variableRef" href="../ored/log_8hpp.html#a08cf33440c824c6fda734c566a726536a604ac82e88d7a367d4c2830411520c2b">data</a>-&gt;engine(<span class="stringliteral">&quot;FxOption&quot;</span>) = <span class="stringliteral">&quot;AnalyticEuropeanEngine&quot;</span>;</div>
<div class="line"><span class="lineno">  452</span>    QuantLib::ext::shared_ptr&lt;EngineFactory&gt; factory = QuantLib::ext::make_shared&lt;EngineFactory&gt;(data, simMarket);</div>
<div class="line"><span class="lineno">  453</span> </div>
<div class="line"><span class="lineno">  454</span>    <span class="comment">// QuantLib::ext::shared_ptr&lt;Portfolio&gt; portfolio = buildSwapPortfolio(portfolioSize, factory);</span></div>
<div class="line"><span class="lineno">  455</span>    QuantLib::ext::shared_ptr&lt;Portfolio&gt; portfolio(<span class="keyword">new</span> <a class="code hl_classRef" href="../ored/classore_1_1data_1_1_portfolio.html">Portfolio</a>());</div>
<div class="line"><span class="lineno">  456</span>    portfolio-&gt;add(<a class="code hl_function" href="namespacetestsuite.html#a54c1b35c30d28826bf94589a5e9d09d6">testsuite::buildSwap</a>(<span class="stringliteral">&quot;1_Swap_EUR&quot;</span>, <span class="stringliteral">&quot;EUR&quot;</span>, <span class="keyword">true</span>, 10.0, 0, 10, 0.03, 0.00, <span class="stringliteral">&quot;1Y&quot;</span>, <span class="stringliteral">&quot;30/360&quot;</span>,</div>
<div class="line"><span class="lineno">  457</span>                                                <span class="stringliteral">&quot;6M&quot;</span>, <span class="stringliteral">&quot;A360&quot;</span>, <span class="stringliteral">&quot;EUR-EURIBOR-6M&quot;</span>));</div>
<div class="line"><span class="lineno">  458</span>    portfolio-&gt;add(<a class="code hl_function" href="namespacetestsuite.html#a4c5e42f43e26063265814439ec599f53">testsuite::buildFxOption</a>(<span class="stringliteral">&quot;7_FxOption_EUR_USD&quot;</span>, <span class="stringliteral">&quot;Long&quot;</span>, <span class="stringliteral">&quot;Call&quot;</span>, 3, <span class="stringliteral">&quot;EUR&quot;</span>, 10.0, <span class="stringliteral">&quot;USD&quot;</span>, 11.0));</div>
<div class="line"><span class="lineno">  459</span>    portfolio-&gt;build(factory);</div>
<div class="line"><span class="lineno">  460</span> </div>
<div class="line"><span class="lineno">  461</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Portfolio size after build: &quot;</span> &lt;&lt; portfolio-&gt;size());</div>
<div class="line"><span class="lineno">  462</span> </div>
<div class="line"><span class="lineno">  463</span>    <span class="comment">// analytic results</span></div>
<div class="line"><span class="lineno">  464</span> </div>
<div class="line"><span class="lineno">  465</span>    std::map&lt;string, Real&gt; analyticalResultsDelta, analyticalResultsGamma, analyticalResultsCrossGamma;</div>
<div class="line"><span class="lineno">  466</span>    std::vector&lt;Real&gt; bucketTimes, bucketTimesVegaOpt, bucketTimesVegaUnd, bucketTimesFxOpt;</div>
<div class="line"><span class="lineno">  467</span>    std::vector&lt;string&gt; bucketStr, numStr, bucketStrVega, numStrVega, bucketStrFxVega, numStrFxVega;</div>
<div class="line"><span class="lineno">  468</span>    ActualActual dc(ActualActual::ISDA); <span class="comment">// this is the dc used for the init / sim market curves</span></div>
<div class="line"><span class="lineno">  469</span>    Size i = 0;</div>
<div class="line"><span class="lineno">  470</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; p : sensiData-&gt;discountCurveShiftData()[<span class="stringliteral">&quot;EUR&quot;</span>]-&gt;shiftTenors) {</div>
<div class="line"><span class="lineno">  471</span>        bucketTimes.push_back(dc.yearFraction(today, today + p));</div>
<div class="line"><span class="lineno">  472</span>        ostringstream bs;</div>
<div class="line"><span class="lineno">  473</span>        bs &lt;&lt; p;</div>
<div class="line"><span class="lineno">  474</span>        bucketStr.push_back(bs.str());</div>
<div class="line"><span class="lineno">  475</span>        ostringstream num;</div>
<div class="line"><span class="lineno">  476</span>        num &lt;&lt; i++;</div>
<div class="line"><span class="lineno">  477</span>        numStr.push_back(num.str());</div>
<div class="line"><span class="lineno">  478</span>    }</div>
<div class="line"><span class="lineno">  479</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; p : sensiData-&gt;swaptionVolShiftData()[<span class="stringliteral">&quot;EUR&quot;</span>].shiftExpiries) {</div>
<div class="line"><span class="lineno">  480</span>        bucketTimesVegaOpt.push_back(dc.yearFraction(today, today + p));</div>
<div class="line"><span class="lineno">  481</span>    }</div>
<div class="line"><span class="lineno">  482</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; p : sensiData-&gt;swaptionVolShiftData()[<span class="stringliteral">&quot;EUR&quot;</span>].shiftTerms) {</div>
<div class="line"><span class="lineno">  483</span>        bucketTimesVegaUnd.push_back(dc.yearFraction(today, today + p));</div>
<div class="line"><span class="lineno">  484</span>    }</div>
<div class="line"><span class="lineno">  485</span>    i = 0;</div>
<div class="line"><span class="lineno">  486</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; p1 : sensiData-&gt;swaptionVolShiftData()[<span class="stringliteral">&quot;EUR&quot;</span>].shiftExpiries) {</div>
<div class="line"><span class="lineno">  487</span>        <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; p2 : sensiData-&gt;swaptionVolShiftData()[<span class="stringliteral">&quot;EUR&quot;</span>].shiftTerms) {</div>
<div class="line"><span class="lineno">  488</span>            ostringstream bs, num;</div>
<div class="line"><span class="lineno">  489</span>            bs &lt;&lt; p1 &lt;&lt; <span class="stringliteral">&quot;/&quot;</span> &lt;&lt; p2;</div>
<div class="line"><span class="lineno">  490</span>            num &lt;&lt; i++;</div>
<div class="line"><span class="lineno">  491</span>            bucketStrVega.push_back(bs.str());</div>
<div class="line"><span class="lineno">  492</span>            numStrVega.push_back(num.str());</div>
<div class="line"><span class="lineno">  493</span>        }</div>
<div class="line"><span class="lineno">  494</span>    }</div>
<div class="line"><span class="lineno">  495</span>    i = 0;</div>
<div class="line"><span class="lineno">  496</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; p : sensiData-&gt;fxVolShiftData()[<span class="stringliteral">&quot;EURUSD&quot;</span>].shiftExpiries) {</div>
<div class="line"><span class="lineno">  497</span>        bucketTimesFxOpt.push_back(dc.yearFraction(today, today + p));</div>
<div class="line"><span class="lineno">  498</span>        ostringstream bs, num;</div>
<div class="line"><span class="lineno">  499</span>        bs &lt;&lt; p;</div>
<div class="line"><span class="lineno">  500</span>        num &lt;&lt; i++;</div>
<div class="line"><span class="lineno">  501</span>        bucketStrFxVega.push_back(bs.str());</div>
<div class="line"><span class="lineno">  502</span>        numStrFxVega.push_back(num.str());</div>
<div class="line"><span class="lineno">  503</span>    }</div>
<div class="line"><span class="lineno">  504</span> </div>
<div class="line"><span class="lineno">  505</span>    Size n = bucketTimes.size();</div>
<div class="line"><span class="lineno">  506</span>    <span class="keyword">auto</span> analyticSwapEngine = QuantLib::ext::make_shared&lt;DiscountingSwapEngineDeltaGamma&gt;(simMarket-&gt;discountCurve(<span class="stringliteral">&quot;EUR&quot;</span>),</div>
<div class="line"><span class="lineno">  507</span>                                                                                  bucketTimes, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">  508</span>    <span class="keyword">auto</span> swap0 = portfolio-&gt;trades().begin()-&gt;second-&gt;instrument()-&gt;qlInstrument();</div>
<div class="line"><span class="lineno">  509</span>    swap0-&gt;setPricingEngine(analyticSwapEngine);</div>
<div class="line"><span class="lineno">  510</span>    <span class="keyword">auto</span> deltaDsc0 = swap0-&gt;result&lt;std::vector&lt;Real&gt;&gt;(<span class="stringliteral">&quot;deltaDiscount&quot;</span>);</div>
<div class="line"><span class="lineno">  511</span>    <span class="keyword">auto</span> deltaFwd0 = swap0-&gt;result&lt;std::vector&lt;Real&gt;&gt;(<span class="stringliteral">&quot;deltaForward&quot;</span>);</div>
<div class="line"><span class="lineno">  512</span>    <span class="keyword">auto</span> gamma0 = swap0-&gt;result&lt;Matrix&gt;(<span class="stringliteral">&quot;gamma&quot;</span>);</div>
<div class="line"><span class="lineno">  513</span> </div>
<div class="line"><span class="lineno">  514</span>    <span class="keyword">auto</span> process =</div>
<div class="line"><span class="lineno">  515</span>        QuantLib::ext::make_shared&lt;GarmanKohlagenProcess&gt;(simMarket-&gt;fxRate(<span class="stringliteral">&quot;EURUSD&quot;</span>), simMarket-&gt;discountCurve(<span class="stringliteral">&quot;EUR&quot;</span>),</div>
<div class="line"><span class="lineno">  516</span>                                                  simMarket-&gt;discountCurve(<span class="stringliteral">&quot;USD&quot;</span>), simMarket-&gt;fxVol(<span class="stringliteral">&quot;EURUSD&quot;</span>));</div>
<div class="line"><span class="lineno">  517</span>    <span class="keyword">auto</span> analyticFxEngine =</div>
<div class="line"><span class="lineno">  518</span>        QuantLib::ext::make_shared&lt;AnalyticEuropeanEngineDeltaGamma&gt;(process, bucketTimes, bucketTimesFxOpt, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">  519</span>    <span class="keyword">auto</span> fxoption2 = (++portfolio-&gt;trades().begin())-&gt;second-&gt;instrument()-&gt;qlInstrument();</div>
<div class="line"><span class="lineno">  520</span>    fxoption2-&gt;setPricingEngine(analyticFxEngine);</div>
<div class="line"><span class="lineno">  521</span>    Real deltaSpot2 = fxoption2-&gt;result&lt;Real&gt;(<span class="stringliteral">&quot;deltaSpot&quot;</span>);</div>
<div class="line"><span class="lineno">  522</span>    Real gammaSpot2 = fxoption2-&gt;result&lt;Real&gt;(<span class="stringliteral">&quot;gammaSpot&quot;</span>);</div>
<div class="line"><span class="lineno">  523</span>    <span class="keyword">auto</span> vega2 = fxoption2-&gt;result&lt;std::vector&lt;Real&gt;&gt;(<span class="stringliteral">&quot;vega&quot;</span>);</div>
<div class="line"><span class="lineno">  524</span>    <span class="keyword">auto</span> deltaRate2 = fxoption2-&gt;result&lt;std::vector&lt;Real&gt;&gt;(<span class="stringliteral">&quot;deltaRate&quot;</span>);</div>
<div class="line"><span class="lineno">  525</span>    <span class="keyword">auto</span> deltaDividend2 = fxoption2-&gt;result&lt;std::vector&lt;Real&gt;&gt;(<span class="stringliteral">&quot;deltaDividend&quot;</span>);</div>
<div class="line"><span class="lineno">  526</span>    <span class="keyword">auto</span> gamma2 = fxoption2-&gt;result&lt;Matrix&gt;(<span class="stringliteral">&quot;gamma&quot;</span>);</div>
<div class="line"><span class="lineno">  527</span>    Real fxnpv = fxoption2-&gt;NPV();</div>
<div class="line"><span class="lineno">  528</span>    Real fxspot = simMarket-&gt;fxRate(<span class="stringliteral">&quot;EURUSD&quot;</span>)-&gt;value();</div>
<div class="line"><span class="lineno">  529</span> </div>
<div class="line"><span class="lineno">  530</span>    std::vector&lt;string&gt; dscKey, dscKey2, fwdKey;</div>
<div class="line"><span class="lineno">  531</span>    <span class="keywordflow">for</span> (Size i = 0; i &lt; n; ++i) {</div>
<div class="line"><span class="lineno">  532</span>        dscKey.push_back(<span class="stringliteral">&quot;DiscountCurve/EUR/&quot;</span> + numStr[i] + <span class="stringliteral">&quot;/&quot;</span> + bucketStr[i]);</div>
<div class="line"><span class="lineno">  533</span>        dscKey2.push_back(<span class="stringliteral">&quot;DiscountCurve/USD/&quot;</span> + numStr[i] + <span class="stringliteral">&quot;/&quot;</span> + bucketStr[i]);</div>
<div class="line"><span class="lineno">  534</span>        fwdKey.push_back(<span class="stringliteral">&quot;IndexCurve/EUR-EURIBOR-6M/&quot;</span> + numStr[i] + <span class="stringliteral">&quot;/&quot;</span> + bucketStr[i]);</div>
<div class="line"><span class="lineno">  535</span>    }</div>
<div class="line"><span class="lineno">  536</span> </div>
<div class="line"><span class="lineno">  537</span>    <span class="keywordflow">for</span> (Size i = 0; i &lt; n; ++i) {</div>
<div class="line"><span class="lineno">  538</span>        analyticalResultsDelta[<span class="stringliteral">&quot;1_Swap_EUR &quot;</span> + dscKey[i]] = deltaDsc0[i];</div>
<div class="line"><span class="lineno">  539</span>        analyticalResultsDelta[<span class="stringliteral">&quot;1_Swap_EUR &quot;</span> + fwdKey[i]] = deltaFwd0[i];</div>
<div class="line"><span class="lineno">  540</span>        analyticalResultsDelta[<span class="stringliteral">&quot;7_FxOption_EUR_USD &quot;</span> + dscKey[i]] = deltaDividend2[i] * 10.0 / fxspot; <span class="comment">// convert to EUR</span></div>
<div class="line"><span class="lineno">  541</span>        analyticalResultsDelta[<span class="stringliteral">&quot;7_FxOption_EUR_USD &quot;</span> + dscKey2[i]] = deltaRate2[i] * 10.0 / fxspot;    <span class="comment">// convert to EUR</span></div>
<div class="line"><span class="lineno">  542</span>    }</div>
<div class="line"><span class="lineno">  543</span> </div>
<div class="line"><span class="lineno">  544</span>    <span class="keywordflow">for</span> (Size i = 0; i &lt; n; ++i) {</div>
<div class="line"><span class="lineno">  545</span>        analyticalResultsGamma[<span class="stringliteral">&quot;1_Swap_EUR &quot;</span> + dscKey[i]] = gamma0[i][i];</div>
<div class="line"><span class="lineno">  546</span>        analyticalResultsGamma[<span class="stringliteral">&quot;1_Swap_EUR &quot;</span> + fwdKey[i]] = gamma0[n + i][n + i];</div>
<div class="line"><span class="lineno">  547</span>        analyticalResultsGamma[<span class="stringliteral">&quot;7_FxOption_EUR_USD &quot;</span> + dscKey[i]] =</div>
<div class="line"><span class="lineno">  548</span>            gamma2[n + i][n + i] * 10.0 / fxspot;                                                  <span class="comment">// convert to EUR</span></div>
<div class="line"><span class="lineno">  549</span>        analyticalResultsGamma[<span class="stringliteral">&quot;7_FxOption_EUR_USD &quot;</span> + dscKey2[i]] = gamma2[i][i] * 10.0 / fxspot; <span class="comment">// convert to EUR</span></div>
<div class="line"><span class="lineno">  550</span>        <span class="keywordflow">for</span> (Size j = 0; j &lt; n; ++j) {</div>
<div class="line"><span class="lineno">  551</span>            <span class="keywordflow">if</span> (i &lt; j) {</div>
<div class="line"><span class="lineno">  552</span>                analyticalResultsCrossGamma[<span class="stringliteral">&quot;1_Swap_EUR &quot;</span> + dscKey[i] + <span class="stringliteral">&quot; &quot;</span> + dscKey[j]] = gamma0[i][j];</div>
<div class="line"><span class="lineno">  553</span>                analyticalResultsCrossGamma[<span class="stringliteral">&quot;1_Swap_EUR &quot;</span> + fwdKey[i] + <span class="stringliteral">&quot; &quot;</span> + fwdKey[j]] = gamma0[n + i][n + j];</div>
<div class="line"><span class="lineno">  554</span>                analyticalResultsCrossGamma[<span class="stringliteral">&quot;7_FxOption_EUR_USD &quot;</span> + dscKey[i] + <span class="stringliteral">&quot; &quot;</span> + dscKey[j]] =</div>
<div class="line"><span class="lineno">  555</span>                    gamma2[n + i][n + j] * 10.0 / fxspot; <span class="comment">// convert to EUR</span></div>
<div class="line"><span class="lineno">  556</span>                analyticalResultsCrossGamma[<span class="stringliteral">&quot;7_FxOption_EUR_USD &quot;</span> + dscKey2[i] + <span class="stringliteral">&quot; &quot;</span> + dscKey2[j]] =</div>
<div class="line"><span class="lineno">  557</span>                    gamma2[i][j] * 10.0 / fxspot; <span class="comment">// convert to EUR</span></div>
<div class="line"><span class="lineno">  558</span>            }</div>
<div class="line"><span class="lineno">  559</span>            analyticalResultsCrossGamma[<span class="stringliteral">&quot;1_Swap_EUR &quot;</span> + dscKey[i] + <span class="stringliteral">&quot; &quot;</span> + fwdKey[j]] = gamma0[i][n + j];</div>
<div class="line"><span class="lineno">  560</span>            analyticalResultsCrossGamma[<span class="stringliteral">&quot;7_FxOption_EUR_USD &quot;</span> + dscKey[i] + <span class="stringliteral">&quot; &quot;</span> + dscKey2[j]] =</div>
<div class="line"><span class="lineno">  561</span>                gamma2[n + i][j] * 10.0 / fxspot; <span class="comment">// convert to EUR</span></div>
<div class="line"><span class="lineno">  562</span>        }</div>
<div class="line"><span class="lineno">  563</span>    }</div>
<div class="line"><span class="lineno">  564</span> </div>
<div class="line"><span class="lineno">  565</span>    <span class="comment">// the sensitivity framework computes d/dS (npv/S), with S = EURUSD fx rate, npv = NPV in USD</span></div>
<div class="line"><span class="lineno">  566</span>    <span class="comment">// the analytical engine computes d/dS npv, the first expression is</span></div>
<div class="line"><span class="lineno">  567</span>    <span class="comment">// -npv/S^2+ d/dS npv / S</span></div>
<div class="line"><span class="lineno">  568</span>    <span class="comment">// furthermore the analytical engine produces results for an EUR notional of 1 instead of 10</span></div>
<div class="line"><span class="lineno">  569</span>    analyticalResultsDelta[<span class="stringliteral">&quot;7_FxOption_EUR_USD FXSpot/EURUSD/0/spot&quot;</span>] =</div>
<div class="line"><span class="lineno">  570</span>        10.0 * (deltaSpot2 / fxspot - fxnpv / (fxspot * fxspot));</div>
<div class="line"><span class="lineno">  571</span>    <span class="comment">// ... differentiate the above expression by S again gives</span></div>
<div class="line"><span class="lineno">  572</span>    <span class="comment">// 2npv/S^3-2 d/dS npv / S^2 + d^2/dS^2 npv / S</span></div>
<div class="line"><span class="lineno">  573</span>    analyticalResultsGamma[<span class="stringliteral">&quot;7_FxOption_EUR_USD FXSpot/EURUSD/0/spot&quot;</span>] =</div>
<div class="line"><span class="lineno">  574</span>        10.0 * (2.0 * fxnpv / (fxspot * fxspot * fxspot) - 2.0 * deltaSpot2 / (fxspot * fxspot) + gammaSpot2 / fxspot);</div>
<div class="line"><span class="lineno">  575</span> </div>
<div class="line"><span class="lineno">  576</span>    analyticalResultsDelta[<span class="stringliteral">&quot;7_FxOption_EUR_USD FXVolatility/EURUSD/0/5Y/ATM&quot;</span>] =</div>
<div class="line"><span class="lineno">  577</span>        vega2.front() * 10.0 / fxspot; <span class="comment">// we only have one vega bucket</span></div>
<div class="line"><span class="lineno">  578</span> </div>
<div class="line"><span class="lineno">  579</span>    <span class="comment">// sensitivity analysis</span></div>
<div class="line"><span class="lineno">  580</span>    QuantLib::ext::shared_ptr&lt;SensitivityAnalysis&gt; sa = QuantLib::ext::make_shared&lt;SensitivityAnalysis&gt;(</div>
<div class="line"><span class="lineno">  581</span>        portfolio, initMarket, <a class="code hl_variableRef" href="../ored/classore_1_1data_1_1_market.html#ab336651e3455fff1764bf576a5785bbd">Market::defaultConfiguration</a>, data, simMarketData, sensiData, <span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">  582</span>    sa-&gt;generateSensitivities();</div>
<div class="line"><span class="lineno">  583</span>    map&lt;pair&lt;string, string&gt;, Real&gt; deltaMap;</div>
<div class="line"><span class="lineno">  584</span>    map&lt;pair&lt;string, string&gt;, Real&gt; gammaMap;</div>
<div class="line"><span class="lineno">  585</span> </div>
<div class="line"><span class="lineno">  586</span>    <span class="keyword">auto</span> sensiCube = sa-&gt;sensiCube();</div>
<div class="line"><span class="lineno">  587</span>    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; tradeId : portfolio-&gt;ids()) {</div>
<div class="line"><span class="lineno">  588</span>        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; f : sensiCube-&gt;factors()) {</div>
<div class="line"><span class="lineno">  589</span>            <span class="keywordtype">string</span> des = sensiCube-&gt;factorDescription(f);</div>
<div class="line"><span class="lineno">  590</span>            deltaMap[make_pair(tradeId, des)] = sensiCube-&gt;delta(tradeId, f);</div>
<div class="line"><span class="lineno">  591</span>            gammaMap[make_pair(tradeId, des)] = sensiCube-&gt;gamma(tradeId, f);</div>
<div class="line"><span class="lineno">  592</span>        }</div>
<div class="line"><span class="lineno">  593</span>    }</div>
<div class="line"><span class="lineno">  594</span> </div>
<div class="line"><span class="lineno">  595</span>    std::vector&lt;ore::analytics::SensitivityScenarioGenerator::ScenarioDescription&gt; scenDesc =</div>
<div class="line"><span class="lineno">  596</span>        sa-&gt;scenarioGenerator()-&gt;scenarioDescriptions();</div>
<div class="line"><span class="lineno">  597</span>    Real shiftSize = 1E-5; <span class="comment">// shift size</span></div>
<div class="line"><span class="lineno">  598</span> </div>
<div class="line"><span class="lineno">  599</span>    <span class="comment">// check deltas</span></div>
<div class="line"><span class="lineno">  600</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Checking deltas...&quot;</span>);</div>
<div class="line"><span class="lineno">  601</span>    Size foundDeltas = 0, zeroDeltas = 0;</div>
<div class="line"><span class="lineno">  602</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; x : deltaMap) {</div>
<div class="line"><span class="lineno">  603</span>        <span class="keywordtype">string</span> key = x.first.first + <span class="stringliteral">&quot; &quot;</span> + x.first.second;</div>
<div class="line"><span class="lineno">  604</span>        Real scaledResult = x.second / shiftSize;</div>
<div class="line"><span class="lineno">  605</span>        <span class="keywordflow">if</span> (analyticalResultsDelta.count(key) &gt; 0) {</div>
<div class="line"><span class="lineno">  606</span>            <span class="keywordflow">if</span> (!<a class="code hl_namespaceRef" href="../qle/namespacecheck.html">check</a>(analyticalResultsDelta.at(key), scaledResult))</div>
<div class="line"><span class="lineno">  607</span>                BOOST_ERROR(<span class="stringliteral">&quot;Sensitivity analysis result &quot;</span> &lt;&lt; key &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; scaledResult</div>
<div class="line"><span class="lineno">  608</span>                                                           &lt;&lt; <span class="stringliteral">&quot;) could not be verified against analytic result (&quot;</span></div>
<div class="line"><span class="lineno">  609</span>                                                           &lt;&lt; analyticalResultsDelta.at(key) &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>);</div>
<div class="line"><span class="lineno">  610</span>            ++foundDeltas;</div>
<div class="line"><span class="lineno">  611</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  612</span>            <span class="keywordflow">if</span> (!<a class="code hl_functionRef" href="../qle/namespace_quant_ext.html#a1cab4fb6a720eff245acb9f3a7a9e7c5">close_enough</a>(x.second, 0.0))</div>
<div class="line"><span class="lineno">  613</span>                BOOST_ERROR(<span class="stringliteral">&quot;Sensitivity analysis result &quot;</span> &lt;&lt; key &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; scaledResult &lt;&lt; <span class="stringliteral">&quot;) expected to be zero&quot;</span>);</div>
<div class="line"><span class="lineno">  614</span>            ++zeroDeltas;</div>
<div class="line"><span class="lineno">  615</span>        }</div>
<div class="line"><span class="lineno">  616</span>    }</div>
<div class="line"><span class="lineno">  617</span>    <span class="keywordflow">if</span> (foundDeltas != analyticalResultsDelta.size())</div>
<div class="line"><span class="lineno">  618</span>        BOOST_ERROR(<span class="stringliteral">&quot;Mismatch between number of analytical results for delta (&quot;</span></div>
<div class="line"><span class="lineno">  619</span>                    &lt;&lt; analyticalResultsDelta.size() &lt;&lt; <span class="stringliteral">&quot;) and sensitivity results (&quot;</span> &lt;&lt; foundDeltas &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>);</div>
<div class="line"><span class="lineno">  620</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Checked &quot;</span> &lt;&lt; foundDeltas &lt;&lt; <span class="stringliteral">&quot; deltas against analytical values (and &quot;</span> &lt;&lt; zeroDeltas</div>
<div class="line"><span class="lineno">  621</span>                                  &lt;&lt; <span class="stringliteral">&quot; deal-unrelated deltas for zero).&quot;</span>);</div>
<div class="line"><span class="lineno">  622</span> </div>
<div class="line"><span class="lineno">  623</span>    <span class="comment">// check gammas</span></div>
<div class="line"><span class="lineno">  624</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Checking gammas...&quot;</span>);</div>
<div class="line"><span class="lineno">  625</span>    Size foundGammas = 0, zeroGammas = 0;</div>
<div class="line"><span class="lineno">  626</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; x : gammaMap) {</div>
<div class="line"><span class="lineno">  627</span>        <span class="keywordtype">string</span> key = x.first.first + <span class="stringliteral">&quot; &quot;</span> + x.first.second;</div>
<div class="line"><span class="lineno">  628</span>        Real scaledResult = x.second / (shiftSize * shiftSize);</div>
<div class="line"><span class="lineno">  629</span>        <span class="keywordflow">if</span> (analyticalResultsGamma.count(key) &gt; 0) {</div>
<div class="line"><span class="lineno">  630</span>            <span class="keywordflow">if</span> (!<a class="code hl_namespaceRef" href="../qle/namespacecheck.html">check</a>(analyticalResultsGamma.at(key), scaledResult))</div>
<div class="line"><span class="lineno">  631</span>                BOOST_ERROR(<span class="stringliteral">&quot;Sensitivity analysis result &quot;</span> &lt;&lt; key &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; scaledResult</div>
<div class="line"><span class="lineno">  632</span>                                                           &lt;&lt; <span class="stringliteral">&quot;) could not be verified against analytic result (&quot;</span></div>
<div class="line"><span class="lineno">  633</span>                                                           &lt;&lt; analyticalResultsGamma.at(key) &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>);</div>
<div class="line"><span class="lineno">  634</span>            ++foundGammas;</div>
<div class="line"><span class="lineno">  635</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  636</span>            <span class="comment">// the sensi framework produces a Vomma, which we don&#39;t check (it isn&#39;t produced by the analytic sensi</span></div>
<div class="line"><span class="lineno">  637</span>            <span class="comment">// engine)</span></div>
<div class="line"><span class="lineno">  638</span>            <span class="keywordflow">if</span> (!<a class="code hl_functionRef" href="../qle/namespace_quant_ext.html#a1cab4fb6a720eff245acb9f3a7a9e7c5">close_enough</a>(x.second, 0.0) &amp;&amp; key != <span class="stringliteral">&quot;5_Swaption_EUR SwaptionVolatility/EUR/47/10Y/10Y/ATM&quot;</span> &amp;&amp;</div>
<div class="line"><span class="lineno">  639</span>                key != <span class="stringliteral">&quot;7_FxOption_EUR_USD FXVolatility/EURUSD/0/5Y/ATM&quot;</span>)</div>
<div class="line"><span class="lineno">  640</span>                BOOST_ERROR(<span class="stringliteral">&quot;Sensitivity analysis result &quot;</span> &lt;&lt; key &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; scaledResult &lt;&lt; <span class="stringliteral">&quot;) expected to be zero&quot;</span>);</div>
<div class="line"><span class="lineno">  641</span>            ++zeroGammas;</div>
<div class="line"><span class="lineno">  642</span>        }</div>
<div class="line"><span class="lineno">  643</span>    }</div>
<div class="line"><span class="lineno">  644</span>    <span class="keywordflow">if</span> (foundGammas != analyticalResultsGamma.size())</div>
<div class="line"><span class="lineno">  645</span>        BOOST_ERROR(<span class="stringliteral">&quot;Mismatch between number of analytical results for gamma (&quot;</span></div>
<div class="line"><span class="lineno">  646</span>                    &lt;&lt; analyticalResultsGamma.size() &lt;&lt; <span class="stringliteral">&quot;) and sensitivity results (&quot;</span> &lt;&lt; foundGammas &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>);</div>
<div class="line"><span class="lineno">  647</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Checked &quot;</span> &lt;&lt; foundGammas &lt;&lt; <span class="stringliteral">&quot; gammas against analytical values (and &quot;</span> &lt;&lt; zeroGammas</div>
<div class="line"><span class="lineno">  648</span>                                  &lt;&lt; <span class="stringliteral">&quot; deal-unrelated gammas for zero).&quot;</span>);</div>
<div class="line"><span class="lineno">  649</span> </div>
<div class="line"><span class="lineno">  650</span>    <span class="comment">// check cross gammas</span></div>
<div class="line"><span class="lineno">  651</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Checking cross-gammas...&quot;</span>);</div>
<div class="line"><span class="lineno">  652</span>    Size foundCrossGammas = 0, zeroCrossGammas = 0;</div>
<div class="line"><span class="lineno">  653</span>    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [tradeId, trade] : portfolio-&gt;trades()) {</div>
<div class="line"><span class="lineno">  654</span>        <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; s : scenDesc) {</div>
<div class="line"><span class="lineno">  655</span>            <span class="keywordflow">if</span> (s.type() == ShiftScenarioGenerator::ScenarioDescription::Type::Cross) {</div>
<div class="line"><span class="lineno">  656</span>                <span class="keywordtype">string</span> key = tradeId + <span class="stringliteral">&quot; &quot;</span> + s.factor1() + <span class="stringliteral">&quot; &quot;</span> + s.factor2();</div>
<div class="line"><span class="lineno">  657</span>                Real crossGamma = sa-&gt;sensiCube()-&gt;crossGamma(tradeId, make_pair(s.key1(), s.key2()));</div>
<div class="line"><span class="lineno">  658</span>                Real scaledResult = crossGamma / (shiftSize * shiftSize);</div>
<div class="line"><span class="lineno">  659</span>                <span class="comment">// BOOST_TEST_MESSAGE(key &lt;&lt; &quot; &quot; &lt;&lt; scaledResult); // debug</span></div>
<div class="line"><span class="lineno">  660</span>                <span class="keywordflow">if</span> (analyticalResultsCrossGamma.count(key) &gt; 0) {</div>
<div class="line"><span class="lineno">  661</span>                    <span class="keywordflow">if</span> (!<a class="code hl_namespaceRef" href="../qle/namespacecheck.html">check</a>(analyticalResultsCrossGamma.at(key), scaledResult))</div>
<div class="line"><span class="lineno">  662</span>                        BOOST_ERROR(<span class="stringliteral">&quot;Sensitivity analysis result &quot;</span></div>
<div class="line"><span class="lineno">  663</span>                                    &lt;&lt; key &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; scaledResult</div>
<div class="line"><span class="lineno">  664</span>                                    &lt;&lt; <span class="stringliteral">&quot;) could not be verified against analytic result (&quot;</span></div>
<div class="line"><span class="lineno">  665</span>                                    &lt;&lt; analyticalResultsCrossGamma.at(key) &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>);</div>
<div class="line"><span class="lineno">  666</span>                    ++foundCrossGammas;</div>
<div class="line"><span class="lineno">  667</span>                } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  668</span>                    <span class="keywordflow">if</span> (!<a class="code hl_namespaceRef" href="../qle/namespacecheck.html">check</a>(crossGamma, 0.0))</div>
<div class="line"><span class="lineno">  669</span>                        BOOST_ERROR(<span class="stringliteral">&quot;Sensitivity analysis result &quot;</span> &lt;&lt; key &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; scaledResult</div>
<div class="line"><span class="lineno">  670</span>                                                                   &lt;&lt; <span class="stringliteral">&quot;) expected to be zero&quot;</span>);</div>
<div class="line"><span class="lineno">  671</span>                    ++zeroCrossGammas;</div>
<div class="line"><span class="lineno">  672</span>                }</div>
<div class="line"><span class="lineno">  673</span>            }</div>
<div class="line"><span class="lineno">  674</span>        }</div>
<div class="line"><span class="lineno">  675</span>    }</div>
<div class="line"><span class="lineno">  676</span>    <span class="keywordflow">if</span> (foundCrossGammas != analyticalResultsCrossGamma.size())</div>
<div class="line"><span class="lineno">  677</span>        BOOST_ERROR(<span class="stringliteral">&quot;Mismatch between number of analytical results for gamma (&quot;</span></div>
<div class="line"><span class="lineno">  678</span>                    &lt;&lt; analyticalResultsCrossGamma.size() &lt;&lt; <span class="stringliteral">&quot;) and sensitivity results (&quot;</span> &lt;&lt; foundCrossGammas &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>);</div>
<div class="line"><span class="lineno">  679</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Checked &quot;</span> &lt;&lt; foundCrossGammas &lt;&lt; <span class="stringliteral">&quot; cross gammas against analytical values (and &quot;</span></div>
<div class="line"><span class="lineno">  680</span>                                  &lt;&lt; zeroCrossGammas &lt;&lt; <span class="stringliteral">&quot; deal-unrelated cross gammas for zero).&quot;</span>);</div>
<div class="line"><span class="lineno">  681</span> </div>
<div class="line"><span class="lineno">  682</span>    <span class="comment">// debug: dump analytical cross gamma results</span></div>
<div class="line"><span class="lineno">  683</span>    <span class="comment">// for(auto const&amp; x: analyticalResultsCrossGamma) {</span></div>
<div class="line"><span class="lineno">  684</span>    <span class="comment">//     BOOST_TEST_MESSAGE(x.first &lt;&lt; &quot; &quot; &lt;&lt; x.second);</span></div>
<div class="line"><span class="lineno">  685</span>    <span class="comment">// }</span></div>
<div class="line"><span class="lineno">  686</span> </div>
<div class="line"><span class="lineno">  687</span>    ObservationMode::instance().setMode(backupMode);</div>
<div class="line"><span class="lineno">  688</span>    IndexManager::instance().clearHistories();</div>
<div class="line"><span class="lineno">  689</span> </div>
<div class="line"><span class="lineno">  690</span>    BOOST_CHECK(<span class="keyword">true</span>);</div>
<div class="line"><span class="lineno">  691</span>}</div>
<div class="ttc" id="aclassore_1_1analytics_1_1_observation_mode_html_a46c8a310cf4c094f8c80e1cb8dc1f911"><div class="ttname"><a href="classore_1_1analytics_1_1_observation_mode.html#a46c8a310cf4c094f8c80e1cb8dc1f911">ore::analytics::ObservationMode::Mode</a></div><div class="ttdeci">Mode</div><div class="ttdoc">Allowable mode mode.</div><div class="ttdef"><b>Definition:</b> <a href="observationmode_8hpp_source.html#l00044">observationmode.hpp:44</a></div></div>
<div class="ttc" id="aclassore_1_1data_1_1_market_html_ab336651e3455fff1764bf576a5785bbd"><div class="ttname"><a href="../ored/classore_1_1data_1_1_market.html#ab336651e3455fff1764bf576a5785bbd">ore::data::Market::defaultConfiguration</a></div><div class="ttdeci">static const string defaultConfiguration</div></div>
<div class="ttc" id="aclassore_1_1data_1_1_portfolio_html"><div class="ttname"><a href="../ored/classore_1_1data_1_1_portfolio.html">ore::data::Portfolio</a></div></div>
<div class="ttc" id="alog_8hpp_html_a08cf33440c824c6fda734c566a726536a604ac82e88d7a367d4c2830411520c2b"><div class="ttname"><a href="../ored/log_8hpp.html#a08cf33440c824c6fda734c566a726536a604ac82e88d7a367d4c2830411520c2b">data</a></div><div class="ttdeci">data</div></div>
<div class="ttc" id="anamespace_quant_ext_html_a1cab4fb6a720eff245acb9f3a7a9e7c5"><div class="ttname"><a href="../qle/namespace_quant_ext.html#a1cab4fb6a720eff245acb9f3a7a9e7c5">close_enough</a></div><div class="ttdeci">Filter close_enough(const RandomVariable &amp;x, const RandomVariable &amp;y)</div></div>
<div class="ttc" id="anamespacecheck_html"><div class="ttname"><a href="../qle/namespacecheck.html">check</a></div></div>
<div class="ttc" id="anamespacetestsuite_html_a4c5e42f43e26063265814439ec599f53"><div class="ttname"><a href="namespacetestsuite.html#a4c5e42f43e26063265814439ec599f53">testsuite::buildFxOption</a></div><div class="ttdeci">QuantLib::ext::shared_ptr&lt; Trade &gt; buildFxOption(string id, string longShort, string putCall, Size expiry, string boughtCcy, Real boughtAmount, string soldCcy, Real soldAmount, Real premium, string premiumCcy, string premiumDate)</div><div class="ttdef"><b>Definition:</b> <a href="testportfolio_8cpp_source.html#l00185">testportfolio.cpp:185</a></div></div>
<div class="ttc" id="anamespacetestsuite_html_a54c1b35c30d28826bf94589a5e9d09d6"><div class="ttname"><a href="namespacetestsuite.html#a54c1b35c30d28826bf94589a5e9d09d6">testsuite::buildSwap</a></div><div class="ttdeci">QuantLib::ext::shared_ptr&lt; Trade &gt; buildSwap(string id, string ccy, bool isPayer, Real notional, int start, Size term, Real rate, Real spread, string fixedFreq, string fixedDC, string floatFreq, string floatDC, string index, Calendar calendar, Natural spotDays, bool spotStartLag)</div><div class="ttdef"><b>Definition:</b> <a href="testportfolio_8cpp_source.html#l00048">testportfolio.cpp:48</a></div></div>
<div class="ttc" id="atest_2parsensitivityanalysis_8cpp_html_a5fd42c03e26bc9fd3ade2213066b2ac9"><div class="ttname"><a href="test_2parsensitivityanalysis_8cpp.html#a5fd42c03e26bc9fd3ade2213066b2ac9">setupSensitivityScenarioData5</a></div><div class="ttdeci">QuantLib::ext::shared_ptr&lt; SensitivityScenarioData &gt; setupSensitivityScenarioData5(bool parConversion)</div><div class="ttdef"><b>Definition:</b> <a href="test_2parsensitivityanalysis_8cpp_source.html#l00338">parsensitivityanalysis.cpp:338</a></div></div>
<div class="ttc" id="atest_2parsensitivityanalysis_8cpp_html_aa08bc8726d4f893388fcc254b42b9005"><div class="ttname"><a href="test_2parsensitivityanalysis_8cpp.html#aa08bc8726d4f893388fcc254b42b9005">setupSimMarketData5</a></div><div class="ttdeci">QuantLib::ext::shared_ptr&lt; analytics::ScenarioSimMarketParameters &gt; setupSimMarketData5()</div><div class="ttdef"><b>Definition:</b> <a href="test_2parsensitivityanalysis_8cpp_source.html#l00136">parsensitivityanalysis.cpp:136</a></div></div>
</div><!-- fragment --><div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<div class="center"><img src="sensitivityvsanalytic_8cpp_ae617b63114d8963eea782ae740c170d7_cgraph.png" border="0" usemap="#asensitivityvsanalytic_8cpp_ae617b63114d8963eea782ae740c170d7_cgraph" alt=""/></div>
<map name="asensitivityvsanalytic_8cpp_ae617b63114d8963eea782ae740c170d7_cgraph" id="asensitivityvsanalytic_8cpp_ae617b63114d8963eea782ae740c170d7_cgraph">
<area shape="rect" title=" " alt="" coords="5,152,196,177"/>
<area shape="rect" href="namespacetestsuite.html#a4c5e42f43e26063265814439ec599f53" title=" " alt="" coords="246,29,406,55"/>
<area shape="rect" href="namespacetestsuite.html#a54c1b35c30d28826bf94589a5e9d09d6" title=" " alt="" coords="257,103,395,128"/>
<area shape="rect" target="_parent" href="../qle/namespace_quant_ext.html#a1cab4fb6a720eff245acb9f3a7a9e7c5" title=" " alt="" coords="275,152,377,177"/>
<area shape="rect" href="test_2parsensitivityanalysis_8cpp.html#a5fd42c03e26bc9fd3ade2213066b2ac9" title=" " alt="" coords="244,202,408,242"/>
<area shape="rect" href="test_2parsensitivityanalysis_8cpp.html#aa08bc8726d4f893388fcc254b42b9005" title=" " alt="" coords="251,267,401,292"/>
<area shape="rect" target="_parent" href="../ored/group__utilities.html#ga59b5fdda574d90facae95dec2d13040d" title=" " alt="" coords="487,29,568,55"/>
<area shape="rect" target="_parent" href="../ored/namespaceore_1_1data.html#a86651dfeb5c18ee891f7a4734d8cf455" title=" " alt="" coords="462,91,593,116"/>
<area shape="rect" href="test_2parsensitivityanalysis_8cpp.html#aed463aaef4655eabe79fc91734bc0a6d" title=" " alt="" coords="456,209,599,235"/>
</map>
</div>

</div>
</div>
</div><!-- contents -->
<!-- HTML footer for doxygen 1.8.9.1-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by <a href="http://www.doxygen.org/index.html">Doxygen</a>
1.9.5
</small></address>
</body>
</html>
