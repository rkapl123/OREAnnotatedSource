<!-- HTML header for doxygen 1.8.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>OREAnalytics: CollateralExposureHelper Class Reference</title>
<link href="https://fonts.googleapis.com/css?family=Merriweather+Sans|Open+Sans" rel="stylesheet">
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" type="image/png" href="favicon.png">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="oreaextra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
   <div id="projectname"><a href="http://opensourcerisk.org">
       <img src="logo-analytics@2x.png" alt="Logo" width="150" height="68" style="float: left; padding: 15px;"/></a>
   <div id="projectbrief">Reference manual - version 1.7</div>
   </div>
</div>
<!-- end header part --><!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="namespaceore.html">ore</a></li><li class="navelem"><a class="el" href="namespaceore_1_1analytics.html">analytics</a></li><li class="navelem"><a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html">CollateralExposureHelper</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-types">Public Types</a> &#124;
<a href="#pub-static-methods">Static Public Member Functions</a> &#124;
<a href="classore_1_1analytics_1_1_collateral_exposure_helper-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">CollateralExposureHelper Class Reference<div class="ingroups"><a class="el" href="group__analytics.html">Analytics</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>Collateral Exposure Helper.  
 <a href="classore_1_1analytics_1_1_collateral_exposure_helper.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="collatexposurehelper_8hpp_source.html">orea/aggregation/collatexposurehelper.hpp</a>&gt;</code></p>
<div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="closed.png" alt="+"/> Collaboration diagram for CollateralExposureHelper:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<div class="center"><img src="classore_1_1analytics_1_1_collateral_exposure_helper__coll__graph.png" border="0" usemap="#a_collateral_exposure_helper_coll__map" alt="Collaboration graph"/></div>
<map name="_collateral_exposure_helper_coll__map" id="a_collateral_exposure_helper_coll__map">
<area shape="rect" title="Collateral Exposure Helper." alt="" coords="5,5,185,141"/>
</map>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-types"></a>
Public Types</h2></td></tr>
<tr class="memitem:ae2fb950fc8d1f9388248733404704d2f"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2f">CalculationType</a> { <a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa33e94d2249181e0e1f815e7c0affc69b">Symmetric</a>, 
<a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa9182f684195edba0c45ff885efc353dd">AsymmetricCVA</a>, 
<a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa44971f8e9b4421cb0a0f462218e377a5">AsymmetricDVA</a>, 
<a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa724175292085d556aeaa28f6804b8f55">NoLag</a>
 }</td></tr>
<tr class="separator:ae2fb950fc8d1f9388248733404704d2f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-static-methods"></a>
Static Public Member Functions</h2></td></tr>
<tr class="memitem:a32b304530ea003c23663098416e24c3f"><td class="memItemLeft" align="right" valign="top">static Real&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#a32b304530ea003c23663098416e24c3f">marginRequirementCalc</a> (const boost::shared_ptr&lt; <a class="el" href="classore_1_1analytics_1_1_collateral_account.html">CollateralAccount</a> &gt; &amp;collat, const Real &amp;uncollatValue, const Date &amp;simulationDate)</td></tr>
<tr class="separator:a32b304530ea003c23663098416e24c3f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4e35471eb056f7855bf179df65946729"><td class="memTemplParams" colspan="2">template&lt;class T &gt; </td></tr>
<tr class="memitem:a4e35471eb056f7855bf179df65946729"><td class="memTemplItemLeft" align="right" valign="top">static Real&#160;</td><td class="memTemplItemRight" valign="bottom"><a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#a4e35471eb056f7855bf179df65946729">estimateUncollatValue</a> (const Date &amp;simulationDate, const Real &amp;npv_t0, const Date &amp;date_t0, const vector&lt; vector&lt; T &gt;&gt; &amp;scenPvProfiles, const unsigned &amp;scenIndex, const vector&lt; Date &gt; &amp;dateGrid)</td></tr>
<tr class="separator:a4e35471eb056f7855bf179df65946729"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a08ba6478bcbcaa94647fc616f0bcbf0b"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#a08ba6478bcbcaa94647fc616f0bcbf0b">updateMarginCall</a> (const boost::shared_ptr&lt; <a class="el" href="classore_1_1analytics_1_1_collateral_account.html">CollateralAccount</a> &gt; &amp;collat, const Real &amp;uncollatValue, const Date &amp;simulationDate, const Real &amp;accrualFactor, const <a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2f">CalculationType</a> &amp;calcType=<a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa33e94d2249181e0e1f815e7c0affc69b">Symmetric</a>, const bool &amp;eligMarginReqDateUs=true, const bool &amp;eligMarginReqDateCtp=true)</td></tr>
<tr class="separator:a08ba6478bcbcaa94647fc616f0bcbf0b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3fcd4541222891df8be90619f379c7b6"><td class="memItemLeft" align="right" valign="top">static Real&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#a3fcd4541222891df8be90619f379c7b6">creditSupportAmount</a> (const boost::shared_ptr&lt; <a class="elRef" href="../ored/classore_1_1data_1_1_netting_set_definition.html">ore::data::NettingSetDefinition</a> &gt; &amp;nettingSet, const Real &amp;uncollatValueCsaCur)</td></tr>
<tr class="separator:a3fcd4541222891df8be90619f379c7b6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acbce959e08d7584e8592ad818fbbdffb"><td class="memItemLeft" align="right" valign="top">static boost::shared_ptr&lt; vector&lt; boost::shared_ptr&lt; <a class="el" href="classore_1_1analytics_1_1_collateral_account.html">CollateralAccount</a> &gt; &gt; &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#acbce959e08d7584e8592ad818fbbdffb">collateralBalancePaths</a> (const boost::shared_ptr&lt; <a class="elRef" href="../ored/classore_1_1data_1_1_netting_set_definition.html">NettingSetDefinition</a> &gt; &amp;csaDef, const Real &amp;nettingSetPv, const Date &amp;date_t0, const vector&lt; vector&lt; Real &gt;&gt; &amp;nettingSetValues, const Date &amp;nettingSet_maturity, const vector&lt; Date &gt; &amp;dateGrid, const Real &amp;csaFxTodayRate, const vector&lt; vector&lt; Real &gt;&gt; &amp;csaFxScenarioRates, const Real &amp;csaTodayCollatCurve, const vector&lt; vector&lt; Real &gt;&gt; &amp;csaScenCollatCurves, const <a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2f">CalculationType</a> &amp;calcType=<a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa33e94d2249181e0e1f815e7c0affc69b">Symmetric</a>)</td></tr>
<tr class="separator:acbce959e08d7584e8592ad818fbbdffb"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Collateral Exposure Helper. </p>
<p>This class contains helper functions to aid in the calculation of collateralised exposures.</p>
<p>It can be used to calculate margin requirements in the presence of e.g. thresholds and minimum transfer amounts, update collateral account details with e.g. new margin call info, and return collateralised exposures to the user/invoker.</p>
<p>For further information refer to the detailed ORE documentation. </p>

<p class="definition">Definition at line <a class="el" href="collatexposurehelper_8hpp_source.html#l00050">50</a> of file <a class="el" href="collatexposurehelper_8hpp_source.html">collatexposurehelper.hpp</a>.</p>
</div><h2 class="groupheader">Member Enumeration Documentation</h2>
<a id="ae2fb950fc8d1f9388248733404704d2f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae2fb950fc8d1f9388248733404704d2f">&#9670;&nbsp;</a></span>CalculationType</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2f">CalculationType</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Enumeration 'CalculationType' specifies how the collateralised exposures should be calculated (please refer to Sungard white-paper titled "Closing In On the CloseOut"):</p><ul>
<li>'Symmetric' =&gt; margin calls only settled after margin period of risk</li>
<li>'AsymmetricCVA' =&gt; margin requested from ctp only settles after margin period of risk &ndash; (our margin postings settle instantaneously)</li>
<li>'AsymmetricDVA' =&gt; margin postings to ctp only settle after margin period of risk &ndash; (margin calls to receive collateral from counterparty settle instantaneously)</li>
<li>'NoLag' =&gt; margin calls/postings settled without margin period of risk delay </li>
</ul>
<table class="fieldtable">
<tr><th colspan="2">Enumerator</th></tr><tr><td class="fieldname"><a id="ae2fb950fc8d1f9388248733404704d2fa33e94d2249181e0e1f815e7c0affc69b"></a>Symmetric&#160;</td><td class="fielddoc"></td></tr>
<tr><td class="fieldname"><a id="ae2fb950fc8d1f9388248733404704d2fa9182f684195edba0c45ff885efc353dd"></a>AsymmetricCVA&#160;</td><td class="fielddoc"></td></tr>
<tr><td class="fieldname"><a id="ae2fb950fc8d1f9388248733404704d2fa44971f8e9b4421cb0a0f462218e377a5"></a>AsymmetricDVA&#160;</td><td class="fielddoc"></td></tr>
<tr><td class="fieldname"><a id="ae2fb950fc8d1f9388248733404704d2fa724175292085d556aeaa28f6804b8f55"></a>NoLag&#160;</td><td class="fielddoc"></td></tr>
</table>

<p class="definition">Definition at line <a class="el" href="collatexposurehelper_8hpp_source.html#l00063">63</a> of file <a class="el" href="collatexposurehelper_8hpp_source.html">collatexposurehelper.hpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;{ <a class="code" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa33e94d2249181e0e1f815e7c0affc69b">Symmetric</a>, <a class="code" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa9182f684195edba0c45ff885efc353dd">AsymmetricCVA</a>, <a class="code" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa44971f8e9b4421cb0a0f462218e377a5">AsymmetricDVA</a>, <a class="code" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa724175292085d556aeaa28f6804b8f55">NoLag</a> };</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="a32b304530ea003c23663098416e24c3f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a32b304530ea003c23663098416e24c3f">&#9670;&nbsp;</a></span>marginRequirementCalc()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">Real marginRequirementCalc </td>
          <td>(</td>
          <td class="paramtype">const boost::shared_ptr&lt; <a class="el" href="classore_1_1analytics_1_1_collateral_account.html">CollateralAccount</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>collat</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Real &amp;&#160;</td>
          <td class="paramname"><em>uncollatValue</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Date &amp;&#160;</td>
          <td class="paramname"><em>simulationDate</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Calculates CSA margin requirement, taking the following into account</p><ul>
<li>uncollateralised value</li>
<li>collateral value</li>
<li>threshold</li>
<li>minimum transfer amount</li>
<li>independent amount </li>
</ul>

<p class="definition">Definition at line <a class="el" href="collatexposurehelper_8cpp_source.html#l00060">60</a> of file <a class="el" href="collatexposurehelper_8cpp_source.html">collatexposurehelper.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;                                                                                                            {</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="comment">// first step, make sure collateral balance is up to date.</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="comment">//        collat-&gt;updateAccountBalance(simulationDate);</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160; </div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    Real collatBalance = collat-&gt;accountBalance();</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    Real csa = <a class="code" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#a3fcd4541222891df8be90619f379c7b6">creditSupportAmount</a>(collat-&gt;csaDef(), uncollatValue);</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160; </div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    Real openMargins = collat-&gt;outstandingMarginAmount(simulationDate);</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    Real collatShortfall = csa - collatBalance - openMargins;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160; </div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    Real mta;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="keywordflow">if</span> (collatShortfall &gt;= 0.0)</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;      mta = collat-&gt;csaDef()-&gt;csaDetails()-&gt;mtaRcv();</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;      mta = collat-&gt;csaDef()-&gt;csaDetails()-&gt;mtaPay();</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160; </div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    Real deliveryAmount = fabs(collatShortfall) &gt;= mta ? (collatShortfall) : 0.0;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160; </div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="keywordflow">return</span> deliveryAmount;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a4e35471eb056f7855bf179df65946729"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4e35471eb056f7855bf179df65946729">&#9670;&nbsp;</a></span>estimateUncollatValue()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">Real estimateUncollatValue </td>
          <td>(</td>
          <td class="paramtype">const Date &amp;&#160;</td>
          <td class="paramname"><em>simulationDate</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Real &amp;&#160;</td>
          <td class="paramname"><em>npv_t0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Date &amp;&#160;</td>
          <td class="paramname"><em>date_t0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const vector&lt; vector&lt; T &gt;&gt; &amp;&#160;</td>
          <td class="paramname"><em>scenPvProfiles</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const unsigned &amp;&#160;</td>
          <td class="paramname"><em>scenIndex</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const vector&lt; Date &gt; &amp;&#160;</td>
          <td class="paramname"><em>dateGrid</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Performs linear interpolation between dates to estimate the value as of simulationDate. Flat extrapolation at far end. </p>

<p class="definition">Definition at line <a class="el" href="collatexposurehelper_8cpp_source.html#l00101">101</a> of file <a class="el" href="collatexposurehelper_8cpp_source.html">collatexposurehelper.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;                                                                                                              {</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160; </div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    QL_REQUIRE(simulationDate &gt;= date_t0, <span class="stringliteral">&quot;CollatExposureHelper error: simulation date &lt; start date&quot;</span>);</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    QL_REQUIRE(dateGrid[0] &gt;= date_t0, <span class="stringliteral">&quot;CollatExposureHelper error: cube dateGrid starts before t0&quot;</span>);</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160; </div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    <span class="keywordflow">if</span> (simulationDate &gt;= dateGrid.back())</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        <span class="keywordflow">return</span> scenPvProfiles.back()[scenIndex]; <span class="comment">// flat extrapolation</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    <span class="keywordflow">if</span> (simulationDate == date_t0)</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        <span class="keywordflow">return</span> npv_t0;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; dateGrid.size(); i++) {</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        <span class="keywordflow">if</span> (dateGrid[i] == simulationDate)</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;            <span class="comment">// return if collat sim-date is the same as an exposure grid date</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;            <span class="keywordflow">return</span> scenPvProfiles[i][scenIndex];</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="preprocessor">#ifdef FLAT_INTERPOLATION</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (simulationDate &lt; dateGrid.front())</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;            <span class="keywordflow">return</span> scenPvProfiles.front()[scenIndex];</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i &lt; dateGrid.size() - 1 &amp;&amp; simulationDate &gt; dateGrid[i] &amp;&amp; simulationDate &lt; dateGrid[i + 1])</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;            <span class="keywordflow">return</span> scenPvProfiles[i + 1][scenIndex];</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    }</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160; </div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    <span class="comment">// if none of above criteria are met, perform interpolation</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    Date t1, t2;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    Real npv1, npv2;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <span class="keywordflow">if</span> (simulationDate &lt;= dateGrid[0]) {</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        t1 = date_t0;</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        t2 = dateGrid[0];</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        npv1 = npv_t0;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        npv2 = scenPvProfiles[0][scenIndex];</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        vector&lt;Date&gt;::const_iterator it = lower_bound(dateGrid.begin(), dateGrid.end(), simulationDate);</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        QL_REQUIRE(it != dateGrid.end(), <span class="stringliteral">&quot;CollatExposureHelper error; &quot;</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;                                             &lt;&lt; <span class="stringliteral">&quot;date interpolation points not found (it.end())&quot;</span>);</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        QL_REQUIRE(it != dateGrid.begin(), <span class="stringliteral">&quot;CollatExposureHelper error; &quot;</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                                               &lt;&lt; <span class="stringliteral">&quot;date interpolation points not found (it.begin())&quot;</span>);</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        Size pos1 = (it - 1) - dateGrid.begin();</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        Size pos2 = it - dateGrid.begin();</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        t1 = dateGrid[pos1];</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        t2 = dateGrid[pos2];</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        npv1 = scenPvProfiles[pos1][scenIndex];</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        npv2 = scenPvProfiles[pos2][scenIndex];</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    }</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160; </div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    Real newPv = npv1 + ((npv2 - npv1) * (<span class="keywordtype">double</span>(simulationDate - t1) / double(t2 - t1)));</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    QL_REQUIRE((npv1 &lt;= newPv &amp;&amp; newPv &lt;= npv2) || (npv1 &gt;= newPv &amp;&amp; newPv &gt;= npv2),</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;               <span class="stringliteral">&quot;CollatExposureHelper error; &quot;</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;                   &lt;&lt; <span class="stringliteral">&quot;interpolated Pv value &quot;</span> &lt;&lt; newPv &lt;&lt; <span class="stringliteral">&quot; out of range (&quot;</span> &lt;&lt; npv1 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; npv2 &lt;&lt; <span class="stringliteral">&quot;) &quot;</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;                   &lt;&lt; <span class="stringliteral">&quot;for simulation date &quot;</span> &lt;&lt; simulationDate &lt;&lt; <span class="stringliteral">&quot; between &quot;</span> &lt;&lt; t1 &lt;&lt; <span class="stringliteral">&quot; and &quot;</span> &lt;&lt; t2);</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160; </div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    <span class="keywordflow">return</span> newPv;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a08ba6478bcbcaa94647fc616f0bcbf0b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a08ba6478bcbcaa94647fc616f0bcbf0b">&#9670;&nbsp;</a></span>updateMarginCall()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void updateMarginCall </td>
          <td>(</td>
          <td class="paramtype">const boost::shared_ptr&lt; <a class="el" href="classore_1_1analytics_1_1_collateral_account.html">CollateralAccount</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>collat</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Real &amp;&#160;</td>
          <td class="paramname"><em>uncollatValue</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Date &amp;&#160;</td>
          <td class="paramname"><em>simulationDate</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Real &amp;&#160;</td>
          <td class="paramname"><em>accrualFactor</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2f">CalculationType</a> &amp;&#160;</td>
          <td class="paramname"><em>calcType</em> = <code><a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa33e94d2249181e0e1f815e7c0affc69b">Symmetric</a></code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const bool &amp;&#160;</td>
          <td class="paramname"><em>eligMarginReqDateUs</em> = <code>true</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const bool &amp;&#160;</td>
          <td class="paramname"><em>eligMarginReqDateCtp</em> = <code>true</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Checks if margin call is in need of update, and updates if necessary </p>

<p class="definition">Definition at line <a class="el" href="collatexposurehelper_8cpp_source.html#l00155">155</a> of file <a class="el" href="collatexposurehelper_8cpp_source.html">collatexposurehelper.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;                                                                                                                   {</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    collat-&gt;updateAccountBalance(simulationDate, annualisedZeroRate);</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160; </div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    Real margin = <a class="code" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#a32b304530ea003c23663098416e24c3f">marginRequirementCalc</a>(collat, uncollatValue, simulationDate);</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160; </div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    <span class="keywordflow">if</span> (margin != 0.0) {</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <span class="comment">// settle margin call on appropriate date</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        <span class="comment">// (dependent upon MPR and collateralised calculation methodology)</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        Date marginPayDate;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    <span class="comment">// RL 2020-07-17</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <span class="comment">// 1) If the calculation type is set to NoLag:</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="comment">//    Collateral balances are NOT delayed by the MPoR, but we use the close-out NPV in exposure calculations,</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="comment">//    see similar comment and the equivalent change in the post processor.</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="comment">// 2) Otherwise:</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    <span class="comment">//    Collateral balances are delayed by the MPoR (if possible, i.e. the valuation grid has MPoR spacing),</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="comment">//    and we use the default date NPV.</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <span class="comment">//    This is the treatment in the ORE releases up to June 2020).</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    Period lag = (calcType == <a class="code" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa724175292085d556aeaa28f6804b8f55">NoLag</a> ? 0*Days : collat-&gt;csaDef()-&gt;csaDetails()-&gt;marginPeriodOfRisk());</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        <span class="keywordflow">if</span> (margin &gt; 0.0 &amp;&amp; eligMarginReqDateUs) {</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        marginPayDate =</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                (calcType == <a class="code" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa44971f8e9b4421cb0a0f462218e377a5">AsymmetricDVA</a> ? simulationDate : simulationDate + lag);</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            collat-&gt;updateMarginCall(margin, marginPayDate, simulationDate);</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (margin &lt; 0.0 &amp;&amp; eligMarginReqDateCtp) {</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            marginPayDate =</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                (calcType == <a class="code" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa9182f684195edba0c45ff885efc353dd">AsymmetricCVA</a> ? simulationDate : simulationDate + lag);</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;            collat-&gt;updateMarginCall(margin, marginPayDate, simulationDate);</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        }</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    }</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a3fcd4541222891df8be90619f379c7b6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3fcd4541222891df8be90619f379c7b6">&#9670;&nbsp;</a></span>creditSupportAmount()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">Real creditSupportAmount </td>
          <td>(</td>
          <td class="paramtype">const boost::shared_ptr&lt; <a class="elRef" href="../ored/classore_1_1data_1_1_netting_set_definition.html">ore::data::NettingSetDefinition</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>nettingSet</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Real &amp;&#160;</td>
          <td class="paramname"><em>uncollatValueCsaCur</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Computes the Credit Support Amount for the portfolio, given an unsecured exposure as input All calculations done in CSA currency </p>

<p class="definition">Definition at line <a class="el" href="collatexposurehelper_8cpp_source.html#l00082">82</a> of file <a class="el" href="collatexposurehelper_8cpp_source.html">collatexposurehelper.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;                                     {</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160; </div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;   Real ia = nettingSet-&gt;csaDetails()-&gt;independentAmountHeld();</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    Real threshold, csa;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <span class="keywordflow">if</span> (uncollatValueCsaCur - ia &gt;= 0) {</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        threshold = nettingSet-&gt;csaDetails()-&gt;thresholdRcv();</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        csa = max(uncollatValueCsaCur - ia - threshold, 0.0);</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    }</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        threshold = nettingSet-&gt;csaDetails()-&gt;thresholdPay();</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        <span class="comment">// N.B. the min and change of sign on threshold.</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        csa = min(uncollatValueCsaCur - ia + threshold, 0.0);</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    }</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <span class="keywordflow">return</span> csa;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="acbce959e08d7584e8592ad818fbbdffb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acbce959e08d7584e8592ad818fbbdffb">&#9670;&nbsp;</a></span>collateralBalancePaths()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">boost::shared_ptr&lt; vector&lt; boost::shared_ptr&lt; <a class="el" href="classore_1_1analytics_1_1_collateral_account.html">CollateralAccount</a> &gt; &gt; &gt; collateralBalancePaths </td>
          <td>(</td>
          <td class="paramtype">const boost::shared_ptr&lt; <a class="elRef" href="../ored/classore_1_1data_1_1_netting_set_definition.html">NettingSetDefinition</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>csaDef</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Real &amp;&#160;</td>
          <td class="paramname"><em>nettingSetPv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Date &amp;&#160;</td>
          <td class="paramname"><em>date_t0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const vector&lt; vector&lt; Real &gt;&gt; &amp;&#160;</td>
          <td class="paramname"><em>nettingSetValues</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Date &amp;&#160;</td>
          <td class="paramname"><em>nettingSet_maturity</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const vector&lt; Date &gt; &amp;&#160;</td>
          <td class="paramname"><em>dateGrid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Real &amp;&#160;</td>
          <td class="paramname"><em>csaFxTodayRate</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const vector&lt; vector&lt; Real &gt;&gt; &amp;&#160;</td>
          <td class="paramname"><em>csaFxScenarioRates</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const Real &amp;&#160;</td>
          <td class="paramname"><em>csaTodayCollatCurve</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const vector&lt; vector&lt; Real &gt;&gt; &amp;&#160;</td>
          <td class="paramname"><em>csaScenCollatCurves</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2f">CalculationType</a> &amp;&#160;</td>
          <td class="paramname"><em>calcType</em> = <code><a class="el" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa33e94d2249181e0e1f815e7c0affc69b">Symmetric</a></code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Takes a netting set (and scenario exposures) as input and returns collateral balance paths per scenario </p>

<p class="definition">Definition at line <a class="el" href="collatexposurehelper_8cpp_source.html#l00189">189</a> of file <a class="el" href="collatexposurehelper_8cpp_source.html">collatexposurehelper.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                                                                                      {</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        <span class="comment">// step 1; build a collateral account object, assuming t0 balance = 0,</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        <span class="comment">//         and calculate t0 margin requirement</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        boost::shared_ptr&lt;CollateralAccount&gt; tmpAcc(<span class="keyword">new</span> CollateralAccount(csaDef, date_t0));</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        Real bal_t0 = <a class="code" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#a32b304530ea003c23663098416e24c3f">marginRequirementCalc</a>(tmpAcc, nettingSetPv, date_t0);</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160; </div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        <span class="comment">// step 2; build a new collateral account object with t0 balance = bal_t0</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        <span class="comment">// a copy of this new object will be used as base for each scenario collateral path</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        CollateralAccount baseAcc(csaDef, bal_t0, date_t0);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160; </div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        <span class="comment">// step 3; build an empty container for the return value(s)</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        boost::shared_ptr&lt;vector&lt;boost::shared_ptr&lt;CollateralAccount&gt;&gt;&gt; scenarioCollatPaths(</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;            <span class="keyword">new</span> vector&lt;boost::shared_ptr&lt;CollateralAccount&gt;&gt;());</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160; </div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        <span class="comment">// step 4; start loop over scenarios</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        Size numScenarios = nettingSetValues.front().size();</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        QL_REQUIRE(numScenarios == csaFxScenarioRates.front().size(), <span class="stringliteral">&quot;netting values -v- scenario FX rate mismatch&quot;</span>);</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        Date simEndDate = std::min(nettingSet_maturity, dateGrid.back()) + csaDef-&gt;csaDetails()-&gt;marginPeriodOfRisk();</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; numScenarios; i++) {</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;            boost::shared_ptr&lt;CollateralAccount&gt; collat(<span class="keyword">new</span> CollateralAccount(baseAcc));</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;            Date tmpDate = date_t0; <span class="comment">// the date which gets evolved</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;            Date nextMarginReqDateUs = date_t0;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;            Date nextMarginReqDateCtp = date_t0;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;            <span class="keywordflow">while</span> (tmpDate &lt;= simEndDate) {</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;                QL_REQUIRE(tmpDate &lt;= nextMarginReqDateUs &amp;&amp; tmpDate &lt;= nextMarginReqDateCtp &amp;&amp;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;                               (tmpDate == nextMarginReqDateUs || tmpDate == nextMarginReqDateCtp),</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;                           <span class="stringliteral">&quot;collateral balance path generation error; invalid time stepping&quot;</span>);</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;                <span class="keywordtype">bool</span> eligMarginReqDateUs = tmpDate == nextMarginReqDateUs ? true : <span class="keyword">false</span>;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                <span class="keywordtype">bool</span> eligMarginReqDateCtp = tmpDate == nextMarginReqDateCtp ? true : <span class="keyword">false</span>;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                Real uncollatVal = <a class="code" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#a4e35471eb056f7855bf179df65946729">estimateUncollatValue</a>(tmpDate, nettingSetPv, date_t0, nettingSetValues, i, dateGrid);</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;                Real fxValue = <a class="code" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#a4e35471eb056f7855bf179df65946729">estimateUncollatValue</a>(tmpDate, csaFxTodayRate, date_t0, csaFxScenarioRates, i, dateGrid);</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;                Real annualisedZeroRate =</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;                    <a class="code" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#a4e35471eb056f7855bf179df65946729">estimateUncollatValue</a>(tmpDate, csaTodayCollatCurve, date_t0, csaScenCollatCurves, i, dateGrid);</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                uncollatVal /= fxValue;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                <a class="code" href="classore_1_1analytics_1_1_collateral_exposure_helper.html#a08ba6478bcbcaa94647fc616f0bcbf0b">updateMarginCall</a>(collat, uncollatVal, tmpDate, annualisedZeroRate, calcType, eligMarginReqDateUs,</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;                                 eligMarginReqDateCtp);</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160; </div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                <span class="keywordflow">if</span> (nextMarginReqDateUs == tmpDate)</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                    nextMarginReqDateUs = tmpDate + collat-&gt;csaDef()-&gt;csaDetails()-&gt;marginCallFrequency();</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                <span class="keywordflow">if</span> (nextMarginReqDateCtp == tmpDate)</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                    nextMarginReqDateCtp = tmpDate + collat-&gt;csaDef()-&gt;csaDetails()-&gt;marginPostFrequency();</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                tmpDate = std::min(nextMarginReqDateUs, nextMarginReqDateCtp);</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;            }</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;            QL_REQUIRE(tmpDate &gt; simEndDate,</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                       <span class="stringliteral">&quot;collateral balance path generation error; while loop terminated too early. (&quot;</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                           &lt;&lt; tmpDate &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; simEndDate &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>);</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;            <span class="comment">// set account balance to zero after maturity of portfolio</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;            collat-&gt;closeAccount(simEndDate + Period(1, Days));</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;            scenarioCollatPaths-&gt;push_back(collat);</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        }</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        <span class="keywordflow">return</span> scenarioCollatPaths;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        QL_FAIL(e.what());</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    } <span class="keywordflow">catch</span> (...) {</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        QL_FAIL(<span class="stringliteral">&quot;CollateralExposureHelper - unknown error when generating collateralBalancePaths&quot;</span>);</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    }</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;}</div>
</div><!-- fragment --><div id="dynsection-1" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-1-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-1-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-1-content" class="dyncontent" style="display:none;">
<div class="center"><img src="classore_1_1analytics_1_1_collateral_exposure_helper_acbce959e08d7584e8592ad818fbbdffb_icgraph.png" border="0" usemap="#aclassore_1_1analytics_1_1_collateral_exposure_helper_acbce959e08d7584e8592ad818fbbdffb_icgraph" alt=""/></div>
<map name="classore_1_1analytics_1_1_collateral_exposure_helper_acbce959e08d7584e8592ad818fbbdffb_icgraph" id="aclassore_1_1analytics_1_1_collateral_exposure_helper_acbce959e08d7584e8592ad818fbbdffb_icgraph">
<area shape="rect" title=" " alt="" coords="504,13,659,39"/>
<area shape="rect" href="classore_1_1analytics_1_1_netted_exposure_calculator.html#adbbda124bc82269485e3c311a8e294a0" title=" " alt="" coords="255,5,456,47"/>
<area shape="rect" href="classore_1_1analytics_1_1_netted_exposure_calculator.html#a7740c7ab195c03ac140f1f75f633470f" title="Compute exposures along all paths and fill result structures." alt="" coords="5,5,207,47"/>
</map>
</div>

</div>
</div>
</div><!-- contents -->
<div class="ttc" id="aclassore_1_1analytics_1_1_collateral_exposure_helper_html_ae2fb950fc8d1f9388248733404704d2fa33e94d2249181e0e1f815e7c0affc69b"><div class="ttname"><a href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa33e94d2249181e0e1f815e7c0affc69b">ore::analytics::CollateralExposureHelper::Symmetric</a></div><div class="ttdeci">@ Symmetric</div><div class="ttdef"><b>Definition:</b> <a href="collatexposurehelper_8hpp_source.html#l00063">collatexposurehelper.hpp:63</a></div></div>
<div class="ttc" id="aclassore_1_1analytics_1_1_collateral_exposure_helper_html_ae2fb950fc8d1f9388248733404704d2fa44971f8e9b4421cb0a0f462218e377a5"><div class="ttname"><a href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa44971f8e9b4421cb0a0f462218e377a5">ore::analytics::CollateralExposureHelper::AsymmetricDVA</a></div><div class="ttdeci">@ AsymmetricDVA</div><div class="ttdef"><b>Definition:</b> <a href="collatexposurehelper_8hpp_source.html#l00063">collatexposurehelper.hpp:63</a></div></div>
<div class="ttc" id="aclassore_1_1analytics_1_1_collateral_exposure_helper_html_a08ba6478bcbcaa94647fc616f0bcbf0b"><div class="ttname"><a href="classore_1_1analytics_1_1_collateral_exposure_helper.html#a08ba6478bcbcaa94647fc616f0bcbf0b">ore::analytics::CollateralExposureHelper::updateMarginCall</a></div><div class="ttdeci">static void updateMarginCall(const boost::shared_ptr&lt; CollateralAccount &gt; &amp;collat, const Real &amp;uncollatValue, const Date &amp;simulationDate, const Real &amp;accrualFactor, const CalculationType &amp;calcType=Symmetric, const bool &amp;eligMarginReqDateUs=true, const bool &amp;eligMarginReqDateCtp=true)</div><div class="ttdef"><b>Definition:</b> <a href="collatexposurehelper_8cpp_source.html#l00155">collatexposurehelper.cpp:155</a></div></div>
<div class="ttc" id="aclassore_1_1analytics_1_1_collateral_exposure_helper_html_a3fcd4541222891df8be90619f379c7b6"><div class="ttname"><a href="classore_1_1analytics_1_1_collateral_exposure_helper.html#a3fcd4541222891df8be90619f379c7b6">ore::analytics::CollateralExposureHelper::creditSupportAmount</a></div><div class="ttdeci">static Real creditSupportAmount(const boost::shared_ptr&lt; ore::data::NettingSetDefinition &gt; &amp;nettingSet, const Real &amp;uncollatValueCsaCur)</div><div class="ttdef"><b>Definition:</b> <a href="collatexposurehelper_8cpp_source.html#l00082">collatexposurehelper.cpp:82</a></div></div>
<div class="ttc" id="aclassore_1_1analytics_1_1_collateral_exposure_helper_html_ae2fb950fc8d1f9388248733404704d2fa724175292085d556aeaa28f6804b8f55"><div class="ttname"><a href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa724175292085d556aeaa28f6804b8f55">ore::analytics::CollateralExposureHelper::NoLag</a></div><div class="ttdeci">@ NoLag</div><div class="ttdef"><b>Definition:</b> <a href="collatexposurehelper_8hpp_source.html#l00063">collatexposurehelper.hpp:63</a></div></div>
<div class="ttc" id="aclassore_1_1analytics_1_1_collateral_exposure_helper_html_a4e35471eb056f7855bf179df65946729"><div class="ttname"><a href="classore_1_1analytics_1_1_collateral_exposure_helper.html#a4e35471eb056f7855bf179df65946729">ore::analytics::CollateralExposureHelper::estimateUncollatValue</a></div><div class="ttdeci">static Real estimateUncollatValue(const Date &amp;simulationDate, const Real &amp;npv_t0, const Date &amp;date_t0, const vector&lt; vector&lt; T &gt;&gt; &amp;scenPvProfiles, const unsigned &amp;scenIndex, const vector&lt; Date &gt; &amp;dateGrid)</div><div class="ttdef"><b>Definition:</b> <a href="collatexposurehelper_8cpp_source.html#l00101">collatexposurehelper.cpp:101</a></div></div>
<div class="ttc" id="aclassore_1_1analytics_1_1_collateral_exposure_helper_html_ae2fb950fc8d1f9388248733404704d2fa9182f684195edba0c45ff885efc353dd"><div class="ttname"><a href="classore_1_1analytics_1_1_collateral_exposure_helper.html#ae2fb950fc8d1f9388248733404704d2fa9182f684195edba0c45ff885efc353dd">ore::analytics::CollateralExposureHelper::AsymmetricCVA</a></div><div class="ttdeci">@ AsymmetricCVA</div><div class="ttdef"><b>Definition:</b> <a href="collatexposurehelper_8hpp_source.html#l00063">collatexposurehelper.hpp:63</a></div></div>
<div class="ttc" id="aclassore_1_1analytics_1_1_collateral_exposure_helper_html_a32b304530ea003c23663098416e24c3f"><div class="ttname"><a href="classore_1_1analytics_1_1_collateral_exposure_helper.html#a32b304530ea003c23663098416e24c3f">ore::analytics::CollateralExposureHelper::marginRequirementCalc</a></div><div class="ttdeci">static Real marginRequirementCalc(const boost::shared_ptr&lt; CollateralAccount &gt; &amp;collat, const Real &amp;uncollatValue, const Date &amp;simulationDate)</div><div class="ttdef"><b>Definition:</b> <a href="collatexposurehelper_8cpp_source.html#l00060">collatexposurehelper.cpp:60</a></div></div>
<!-- HTML footer for doxygen 1.8.9.1-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by <a href="http://www.doxygen.org/index.html">Doxygen</a>
1.8.20
</small></address>
</body>
</html>
