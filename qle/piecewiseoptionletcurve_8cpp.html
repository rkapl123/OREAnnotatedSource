<!-- HTML header for doxygen 1.8.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<title>QuantExt: test/piecewiseoptionletcurve.cpp File Reference</title>
<link href="https://fonts.googleapis.com/css?family=Merriweather+Sans|Open+Sans" rel="stylesheet">
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" type="image/png" href="favicon.png">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="quantextextra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
   <div id="projectname"><a href="https://rkapl123.github.io/OREAnnotatedSource/">
       <img src="logo-qle@2x.png" alt="Logo" width="150" height="68" style="float: left; padding: 15px;"/></a>
   <div id="projectbrief">Fully annotated reference manual - version 1.8.12</div>
   </div>
</div>
<!-- end header part --><!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_13e138d54eb8818da29c3992edef070a.html">test</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#namespaces">Namespaces</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">piecewiseoptionletcurve.cpp File Reference</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;boost/assign.hpp&gt;</code><br />
<code>#include &lt;boost/test/unit_test.hpp&gt;</code><br />
<code>#include &lt;boost/test/data/test_case.hpp&gt;</code><br />
<code>#include &lt;boost/variant.hpp&gt;</code><br />
<code>#include &lt;<a class="el" href="capfloormarketdata_8hpp_source.html">test/capfloormarketdata.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="toplevelfixture_8hpp_source.html">test/toplevelfixture.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="yieldcurvemarketdata_8hpp_source.html">test/yieldcurvemarketdata.hpp</a>&gt;</code><br />
<code>#include &lt;ql/instruments/makecapfloor.hpp&gt;</code><br />
<code>#include &lt;ql/pricingengines/capfloor/bacheliercapfloorengine.hpp&gt;</code><br />
<code>#include &lt;ql/pricingengines/capfloor/blackcapfloorengine.hpp&gt;</code><br />
<code>#include &lt;ql/time/date.hpp&gt;</code><br />
<code>#include &lt;<a class="el" href="flatextrapolation_8hpp_source.html">qle/math/flatextrapolation.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="capfloorhelper_8hpp_source.html">qle/termstructures/capfloorhelper.hpp</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="piecewiseoptionletcurve_8hpp_source.html">qle/termstructures/piecewiseoptionletcurve.hpp</a>&gt;</code><br />
</div>
<p><a href="piecewiseoptionletcurve_8cpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="namespaces" name="namespaces"></a>
Namespaces</h2></td></tr>
<tr class="memitem:namespaceboost"><td class="memItemLeft" align="right" valign="top">namespace &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceboost.html">boost</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:namespaceboost_1_1test__tools"><td class="memItemLeft" align="right" valign="top">namespace &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceboost_1_1test__tools.html">boost::test_tools</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:namespaceboost_1_1test__tools_1_1tt__detail"><td class="memItemLeft" align="right" valign="top">namespace &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceboost_1_1test__tools_1_1tt__detail.html">boost::test_tools::tt_detail</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="typedef-members" name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:ac28af33f0db47fd24320c0ae0844971f"><td class="memItemLeft" align="right" valign="top">typedef QuantLib::BootstrapHelper&lt; QuantLib::OptionletVolatilityStructure &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="piecewiseoptionletcurve_8cpp.html#ac28af33f0db47fd24320c0ae0844971f">helper</a></td></tr>
<tr class="separator:ac28af33f0db47fd24320c0ae0844971f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:afa04ba038879a7970edf189d6680a70f"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="piecewiseoptionletcurve_8cpp.html#afa04ba038879a7970edf189d6680a70f">BOOST_DATA_TEST_CASE_F</a> (CommonVars, testPiecewiseOptionletStripping, bdata::make(generateVolatilityColumns()) *bdata::make(helperTypes) *bdata::make(quoteTypes) *bdata::make(interpolationTypes) *bdata::make(isMovingValues) *bdata::make(flatFirstPeriodValues), volatilityColumn, helperType, quoteType, interpolationType, isMoving, flatFirstPeriod)</td></tr>
<tr class="separator:afa04ba038879a7970edf189d6680a70f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae30a90cc81914f1079d9583d81cad7c1"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="piecewiseoptionletcurve_8cpp.html#ae30a90cc81914f1079d9583d81cad7c1">BOOST_DATA_TEST_CASE_F</a> (CommonVars, testCachedValues, bdata::make(interpolationTypesCached) *bdata::make(flatFirstPeriodValues), interpolationType, flatFirstPeriod)</td></tr>
<tr class="separator:ae30a90cc81914f1079d9583d81cad7c1"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Typedef Documentation</h2>
<a id="ac28af33f0db47fd24320c0ae0844971f" name="ac28af33f0db47fd24320c0ae0844971f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac28af33f0db47fd24320c0ae0844971f">&#9670;&#160;</a></span>helper</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef QuantLib::BootstrapHelper&lt;QuantLib::OptionletVolatilityStructure&gt; <a class="el" href="piecewiseatmoptionletcurve_8cpp.html#ac28af33f0db47fd24320c0ae0844971f">helper</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="piecewiseoptionletcurve_8cpp_source.html#l00043">43</a> of file <a class="el" href="piecewiseoptionletcurve_8cpp_source.html">piecewiseoptionletcurve.cpp</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="afa04ba038879a7970edf189d6680a70f" name="afa04ba038879a7970edf189d6680a70f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afa04ba038879a7970edf189d6680a70f">&#9670;&#160;</a></span>BOOST_DATA_TEST_CASE_F() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">BOOST_DATA_TEST_CASE_F </td>
          <td>(</td>
          <td class="paramtype">CommonVars&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">testPiecewiseOptionletStripping&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bdata::make(generateVolatilityColumns()) *bdata::make(helperTypes) *bdata::make(quoteTypes) *bdata::make(interpolationTypes) *bdata::make(isMovingValues) *bdata::make(flatFirstPeriodValues)&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">volatilityColumn&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">helperType&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">quoteType&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">interpolationType&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">isMoving&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">flatFirstPeriod&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="piecewiseoptionletcurve_8cpp_source.html#l00269">269</a> of file <a class="el" href="piecewiseoptionletcurve_8cpp_source.html">piecewiseoptionletcurve.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  273</span>                                                                                                              {</div>
<div class="line"><span class="lineno">  274</span> </div>
<div class="line"><span class="lineno">  275</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Testing piecewise optionlet stripping of cap floor quotes along a strike column&quot;</span>);</div>
<div class="line"><span class="lineno">  276</span> </div>
<div class="line"><span class="lineno">  277</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Test inputs are:&quot;</span>);</div>
<div class="line"><span class="lineno">  278</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  Cap floor helper type: &quot;</span> &lt;&lt; helperType);</div>
<div class="line"><span class="lineno">  279</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  Cap floor strike: &quot;</span> &lt;&lt; volatilityColumn.strike);</div>
<div class="line"><span class="lineno">  280</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  Quote type: &quot;</span> &lt;&lt; quoteType);</div>
<div class="line"><span class="lineno">  281</span>    <span class="keywordflow">if</span> (quoteType == <a class="code hl_enumvalue" href="class_quant_ext_1_1_cap_floor_helper.html#aa5b3ec8bb6c730c38b87a73c11dec808adab9ccfeb3c1dbe934be59599c8d7372">CapFloorHelper::Volatility</a>) {</div>
<div class="line"><span class="lineno">  282</span>        BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  Quote volatility type: &quot;</span> &lt;&lt; volatilityColumn.type);</div>
<div class="line"><span class="lineno">  283</span>        BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  Quote displacement: &quot;</span> &lt;&lt; volatilityColumn.displacement);</div>
<div class="line"><span class="lineno">  284</span>    }</div>
<div class="line"><span class="lineno">  285</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  Interpolation type: &quot;</span> &lt;&lt; to_string(interpolationType));</div>
<div class="line"><span class="lineno">  286</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  Floating reference date: &quot;</span> &lt;&lt; boolalpha &lt;&lt; isMoving);</div>
<div class="line"><span class="lineno">  287</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  Flat first period: &quot;</span> &lt;&lt; boolalpha &lt;&lt; flatFirstPeriod);</div>
<div class="line"><span class="lineno">  288</span> </div>
<div class="line"><span class="lineno">  289</span>    <span class="keywordflow">if</span> (quoteType == <a class="code hl_enumvalue" href="class_quant_ext_1_1_cap_floor_helper.html#aa5b3ec8bb6c730c38b87a73c11dec808aa89a292bf1c3cb8652f06442fe67c0b8">CapFloorHelper::Premium</a> &amp;&amp; helperType == <a class="code hl_enumvalue" href="class_quant_ext_1_1_cap_floor_helper.html#a1d1cfd8ffb84e947f82999c682b666a7a9248ea5dc540b00adb523d1b86fc1389">CapFloorHelper::Automatic</a>) {</div>
<div class="line"><span class="lineno">  290</span> </div>
<div class="line"><span class="lineno">  291</span>        <span class="comment">// This is a combination that should throw an error when creating the helper</span></div>
<div class="line"><span class="lineno">  292</span>        <span class="comment">// Don&#39;t care about the value of the premium quote</span></div>
<div class="line"><span class="lineno">  293</span>        Handle&lt;Quote&gt; quote(QuantLib::ext::make_shared&lt;SimpleQuote&gt;(0.01));</div>
<div class="line"><span class="lineno">  294</span>        BOOST_REQUIRE_THROW(</div>
<div class="line"><span class="lineno">  295</span>            QuantLib::ext::make_shared&lt;CapFloorHelper&gt;(helperType, volatilityColumn.tenors.front(), volatilityColumn.strike,</div>
<div class="line"><span class="lineno">  296</span>                                               quote, iborIndex, testYieldCurves.discountEonia, isMoving, Date(),</div>
<div class="line"><span class="lineno">  297</span>                                               quoteType, volatilityColumn.type, volatilityColumn.displacement),</div>
<div class="line"><span class="lineno">  298</span>            Error);</div>
<div class="line"><span class="lineno">  299</span> </div>
<div class="line"><span class="lineno">  300</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  301</span> </div>
<div class="line"><span class="lineno">  302</span>        <span class="comment">// Form the cap floor helper instrument for each tenor in the strike column</span></div>
<div class="line"><span class="lineno">  303</span>        vector&lt;QuantLib::ext::shared_ptr&lt;helper&gt; &gt; helpers(volatilityColumn.tenors.size());</div>
<div class="line"><span class="lineno">  304</span> </div>
<div class="line"><span class="lineno">  305</span>        <span class="comment">// Store each cap floor instrument in the strike column and its NPV using the flat cap floor volatilities</span></div>
<div class="line"><span class="lineno">  306</span>        vector&lt;QuantLib::ext::shared_ptr&lt;CapFloor&gt; &gt; instruments(volatilityColumn.tenors.size());</div>
<div class="line"><span class="lineno">  307</span>        vector&lt;Real&gt; flatNpvs(volatilityColumn.tenors.size());</div>
<div class="line"><span class="lineno">  308</span> </div>
<div class="line"><span class="lineno">  309</span>        BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;The input values at each tenor are:&quot;</span>);</div>
<div class="line"><span class="lineno">  310</span>        <span class="keywordflow">for</span> (Size i = 0; i &lt; volatilityColumn.tenors.size(); i++) {</div>
<div class="line"><span class="lineno">  311</span> </div>
<div class="line"><span class="lineno">  312</span>            <span class="comment">// Get the relevant quote value</span></div>
<div class="line"><span class="lineno">  313</span>            Real volatility = volatilityColumn.volatilities[i];</div>
<div class="line"><span class="lineno">  314</span> </div>
<div class="line"><span class="lineno">  315</span>            <span class="comment">// Create the cap floor instrument and store its price using the quoted flat volatility</span></div>
<div class="line"><span class="lineno">  316</span>            CapFloor::Type capFloorType = CapFloor::Cap;</div>
<div class="line"><span class="lineno">  317</span>            <span class="keywordflow">if</span> (helperType == <a class="code hl_enumvalue" href="class_quant_ext_1_1_cap_floor_helper.html#a1d1cfd8ffb84e947f82999c682b666a7a94e95e4b8360855608dfad0b1f43a301">CapFloorHelper::Floor</a>) {</div>
<div class="line"><span class="lineno">  318</span>                capFloorType = CapFloor::Floor;</div>
<div class="line"><span class="lineno">  319</span>            }</div>
<div class="line"><span class="lineno">  320</span>            instruments[i] = MakeCapFloor(capFloorType, volatilityColumn.tenors[i], iborIndex, volatilityColumn.strike);</div>
<div class="line"><span class="lineno">  321</span>            <span class="keywordflow">if</span> (volatilityColumn.type == ShiftedLognormal) {</div>
<div class="line"><span class="lineno">  322</span>                instruments[i]-&gt;setPricingEngine(QuantLib::ext::make_shared&lt;BlackCapFloorEngine&gt;(</div>
<div class="line"><span class="lineno">  323</span>                    testYieldCurves.discountEonia, volatility, dayCounter, volatilityColumn.displacement));</div>
<div class="line"><span class="lineno">  324</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  325</span>                instruments[i]-&gt;setPricingEngine(</div>
<div class="line"><span class="lineno">  326</span>                    QuantLib::ext::make_shared&lt;BachelierCapFloorEngine&gt;(testYieldCurves.discountEonia, volatility, dayCounter));</div>
<div class="line"><span class="lineno">  327</span>            }</div>
<div class="line"><span class="lineno">  328</span>            flatNpvs[i] = instruments[i]-&gt;NPV();</div>
<div class="line"><span class="lineno">  329</span> </div>
<div class="line"><span class="lineno">  330</span>            BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  (Cap/Floor, Tenor, Volatility, Flat NPV) = (&quot;</span></div>
<div class="line"><span class="lineno">  331</span>                               &lt;&lt; capFloorType &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; volatilityColumn.tenors[i] &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; fixed</div>
<div class="line"><span class="lineno">  332</span>                               &lt;&lt; setprecision(13) &lt;&lt; volatility &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; flatNpvs[i] &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>);</div>
<div class="line"><span class="lineno">  333</span> </div>
<div class="line"><span class="lineno">  334</span>            <span class="comment">// Create a volatility or premium quote</span></div>
<div class="line"><span class="lineno">  335</span>            RelinkableHandle&lt;Quote&gt; quote;</div>
<div class="line"><span class="lineno">  336</span>            <span class="keywordflow">if</span> (quoteType == <a class="code hl_enumvalue" href="class_quant_ext_1_1_cap_floor_helper.html#aa5b3ec8bb6c730c38b87a73c11dec808adab9ccfeb3c1dbe934be59599c8d7372">CapFloorHelper::Volatility</a>) {</div>
<div class="line"><span class="lineno">  337</span>                quote.linkTo(QuantLib::ext::make_shared&lt;SimpleQuote&gt;(volatility));</div>
<div class="line"><span class="lineno">  338</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  339</span>                quote.linkTo(QuantLib::ext::make_shared&lt;SimpleQuote&gt;(flatNpvs[i]));</div>
<div class="line"><span class="lineno">  340</span>            }</div>
<div class="line"><span class="lineno">  341</span> </div>
<div class="line"><span class="lineno">  342</span>            <span class="comment">// Create the helper instrument</span></div>
<div class="line"><span class="lineno">  343</span>            helpers[i] =</div>
<div class="line"><span class="lineno">  344</span>                QuantLib::ext::make_shared&lt;CapFloorHelper&gt;(helperType, volatilityColumn.tenors[i], volatilityColumn.strike,</div>
<div class="line"><span class="lineno">  345</span>                                                   quote, iborIndex, testYieldCurves.discountEonia, isMoving, Date(),</div>
<div class="line"><span class="lineno">  346</span>                                                   quoteType, volatilityColumn.type, volatilityColumn.displacement);</div>
<div class="line"><span class="lineno">  347</span>        }</div>
<div class="line"><span class="lineno">  348</span> </div>
<div class="line"><span class="lineno">  349</span>        <span class="comment">// Create the piecewise optionlet curve, with the given interpolation type, and fail if it is not created</span></div>
<div class="line"><span class="lineno">  350</span>        VolatilityType curveVolatilityType = Normal;</div>
<div class="line"><span class="lineno">  351</span>        Real curveDisplacement = 0.0;</div>
<div class="line"><span class="lineno">  352</span>        QuantLib::ext::shared_ptr&lt;OptionletVolatilityStructure&gt; ovCurve;</div>
<div class="line"><span class="lineno">  353</span>        <span class="keywordflow">switch</span> (interpolationType.which()) {</div>
<div class="line"><span class="lineno">  354</span>        <span class="keywordflow">case</span> 0:</div>
<div class="line"><span class="lineno">  355</span>            <span class="keywordflow">if</span> (isMoving) {</div>
<div class="line"><span class="lineno">  356</span>                BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Using Linear interpolation with a moving reference date&quot;</span>);</div>
<div class="line"><span class="lineno">  357</span>                BOOST_REQUIRE_NO_THROW(ovCurve = QuantLib::ext::make_shared&lt;<a class="code hl_class" href="class_quant_ext_1_1_piecewise_optionlet_curve.html">PiecewiseOptionletCurve&lt;Linear&gt;</a> &gt;(</div>
<div class="line"><span class="lineno">  358</span>                                           settlementDays, helpers, calendar, bdc, dayCounter, curveVolatilityType,</div>
<div class="line"><span class="lineno">  359</span>                                           curveDisplacement, flatFirstPeriod));</div>
<div class="line"><span class="lineno">  360</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  361</span>                BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Using Linear interpolation with a fixed reference date&quot;</span>);</div>
<div class="line"><span class="lineno">  362</span>                BOOST_REQUIRE_NO_THROW(ovCurve = QuantLib::ext::make_shared&lt;<a class="code hl_class" href="class_quant_ext_1_1_piecewise_optionlet_curve.html">PiecewiseOptionletCurve&lt;Linear&gt;</a> &gt;(</div>
<div class="line"><span class="lineno">  363</span>                                           referenceDate, helpers, calendar, bdc, dayCounter, curveVolatilityType,</div>
<div class="line"><span class="lineno">  364</span>                                           curveDisplacement, flatFirstPeriod));</div>
<div class="line"><span class="lineno">  365</span>            }</div>
<div class="line"><span class="lineno">  366</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  367</span>        <span class="keywordflow">case</span> 1:</div>
<div class="line"><span class="lineno">  368</span>            <span class="keywordflow">if</span> (isMoving) {</div>
<div class="line"><span class="lineno">  369</span>                BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Using BackwardFlat interpolation with a moving reference date&quot;</span>);</div>
<div class="line"><span class="lineno">  370</span>                BOOST_REQUIRE_NO_THROW(ovCurve = QuantLib::ext::make_shared&lt;<a class="code hl_class" href="class_quant_ext_1_1_piecewise_optionlet_curve.html">PiecewiseOptionletCurve&lt;BackwardFlat&gt;</a> &gt;(</div>
<div class="line"><span class="lineno">  371</span>                                           settlementDays, helpers, calendar, bdc, dayCounter, curveVolatilityType,</div>
<div class="line"><span class="lineno">  372</span>                                           curveDisplacement, flatFirstPeriod));</div>
<div class="line"><span class="lineno">  373</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  374</span>                BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Using BackwardFlat interpolation with a fixed reference date&quot;</span>);</div>
<div class="line"><span class="lineno">  375</span>                BOOST_REQUIRE_NO_THROW(ovCurve = QuantLib::ext::make_shared&lt;<a class="code hl_class" href="class_quant_ext_1_1_piecewise_optionlet_curve.html">PiecewiseOptionletCurve&lt;BackwardFlat&gt;</a> &gt;(</div>
<div class="line"><span class="lineno">  376</span>                                           referenceDate, helpers, calendar, bdc, dayCounter, curveVolatilityType,</div>
<div class="line"><span class="lineno">  377</span>                                           curveDisplacement, flatFirstPeriod));</div>
<div class="line"><span class="lineno">  378</span>            }</div>
<div class="line"><span class="lineno">  379</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  380</span>        <span class="keywordflow">case</span> 2:</div>
<div class="line"><span class="lineno">  381</span>            <span class="keywordflow">if</span> (isMoving) {</div>
<div class="line"><span class="lineno">  382</span>                BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Using LinearFlat interpolation with a moving reference date&quot;</span>);</div>
<div class="line"><span class="lineno">  383</span>                BOOST_REQUIRE_NO_THROW(ovCurve = QuantLib::ext::make_shared&lt;<a class="code hl_class" href="class_quant_ext_1_1_piecewise_optionlet_curve.html">PiecewiseOptionletCurve&lt;LinearFlat&gt;</a> &gt;(</div>
<div class="line"><span class="lineno">  384</span>                                           settlementDays, helpers, calendar, bdc, dayCounter, curveVolatilityType,</div>
<div class="line"><span class="lineno">  385</span>                                           curveDisplacement, flatFirstPeriod));</div>
<div class="line"><span class="lineno">  386</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  387</span>                BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Using LinearFlat interpolation with a fixed reference date&quot;</span>);</div>
<div class="line"><span class="lineno">  388</span>                BOOST_REQUIRE_NO_THROW(ovCurve = QuantLib::ext::make_shared&lt;<a class="code hl_class" href="class_quant_ext_1_1_piecewise_optionlet_curve.html">PiecewiseOptionletCurve&lt;LinearFlat&gt;</a> &gt;(</div>
<div class="line"><span class="lineno">  389</span>                                           referenceDate, helpers, calendar, bdc, dayCounter, curveVolatilityType,</div>
<div class="line"><span class="lineno">  390</span>                                           curveDisplacement, flatFirstPeriod));</div>
<div class="line"><span class="lineno">  391</span>            }</div>
<div class="line"><span class="lineno">  392</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  393</span>        <span class="keywordflow">case</span> 3:</div>
<div class="line"><span class="lineno">  394</span>            <span class="keywordflow">if</span> (isMoving) {</div>
<div class="line"><span class="lineno">  395</span>                BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Using Cubic interpolation with a moving reference date&quot;</span>);</div>
<div class="line"><span class="lineno">  396</span>                BOOST_REQUIRE_NO_THROW(</div>
<div class="line"><span class="lineno">  397</span>                    ovCurve = QuantLib::ext::make_shared&lt;<a class="code hl_class" href="class_quant_ext_1_1_piecewise_optionlet_curve.html">PiecewiseOptionletCurve&lt;Cubic&gt;</a> &gt;(</div>
<div class="line"><span class="lineno">  398</span>                        settlementDays, helpers, calendar, bdc, dayCounter, curveVolatilityType, curveDisplacement,</div>
<div class="line"><span class="lineno">  399</span>                        flatFirstPeriod, Cubic(),</div>
<div class="line"><span class="lineno">  400</span>                        <a class="code hl_class" href="class_quant_ext_1_1_iterative_bootstrap.html">QuantExt::IterativeBootstrap</a>&lt;</div>
<div class="line"><span class="lineno">  401</span>                            <a class="code hl_class" href="class_quant_ext_1_1_piecewise_optionlet_curve.html">PiecewiseOptionletCurve&lt;Cubic, QuantExt::IterativeBootstrap&gt;::this_curve</a>&gt;(accuracy,</div>
<div class="line"><span class="lineno">  402</span>                                                                                                      globalAccuracy)));</div>
<div class="line"><span class="lineno">  403</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  404</span>                BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Using Cubic interpolation with a fixed reference date&quot;</span>);</div>
<div class="line"><span class="lineno">  405</span>                BOOST_REQUIRE_NO_THROW(</div>
<div class="line"><span class="lineno">  406</span>                    ovCurve = QuantLib::ext::make_shared&lt;<a class="code hl_class" href="class_quant_ext_1_1_piecewise_optionlet_curve.html">PiecewiseOptionletCurve&lt;Cubic&gt;</a> &gt;(</div>
<div class="line"><span class="lineno">  407</span>                        referenceDate, helpers, calendar, bdc, dayCounter, curveVolatilityType, curveDisplacement,</div>
<div class="line"><span class="lineno">  408</span>                        flatFirstPeriod, Cubic(),</div>
<div class="line"><span class="lineno">  409</span>                        <a class="code hl_class" href="class_quant_ext_1_1_iterative_bootstrap.html">QuantExt::IterativeBootstrap</a>&lt;</div>
<div class="line"><span class="lineno">  410</span>                            <a class="code hl_class" href="class_quant_ext_1_1_piecewise_optionlet_curve.html">PiecewiseOptionletCurve&lt;Cubic, QuantExt::IterativeBootstrap&gt;::this_curve</a>&gt;(accuracy,</div>
<div class="line"><span class="lineno">  411</span>                                                                                                      globalAccuracy)));</div>
<div class="line"><span class="lineno">  412</span>            }</div>
<div class="line"><span class="lineno">  413</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  414</span>        <span class="keywordflow">case</span> 4:</div>
<div class="line"><span class="lineno">  415</span>            <span class="keywordflow">if</span> (isMoving) {</div>
<div class="line"><span class="lineno">  416</span>                BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Using CubicFlat interpolation with a moving reference date&quot;</span>);</div>
<div class="line"><span class="lineno">  417</span>                BOOST_REQUIRE_NO_THROW(</div>
<div class="line"><span class="lineno">  418</span>                    ovCurve = QuantLib::ext::make_shared&lt;<a class="code hl_class" href="class_quant_ext_1_1_piecewise_optionlet_curve.html">PiecewiseOptionletCurve&lt;CubicFlat&gt;</a> &gt;(</div>
<div class="line"><span class="lineno">  419</span>                        settlementDays, helpers, calendar, bdc, dayCounter, curveVolatilityType, curveDisplacement,</div>
<div class="line"><span class="lineno">  420</span>                        flatFirstPeriod, <a class="code hl_class" href="class_quant_ext_1_1_cubic_flat.html">CubicFlat</a>(),</div>
<div class="line"><span class="lineno">  421</span>                        <a class="code hl_class" href="class_quant_ext_1_1_iterative_bootstrap.html">QuantExt::IterativeBootstrap</a>&lt;</div>
<div class="line"><span class="lineno">  422</span>                            <a class="code hl_class" href="class_quant_ext_1_1_piecewise_optionlet_curve.html">PiecewiseOptionletCurve&lt;CubicFlat, QuantExt::IterativeBootstrap&gt;::this_curve</a>&gt;(</div>
<div class="line"><span class="lineno">  423</span>                            accuracy, globalAccuracy)));</div>
<div class="line"><span class="lineno">  424</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  425</span>                BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Using CubicFlat interpolation with a fixed reference date&quot;</span>);</div>
<div class="line"><span class="lineno">  426</span>                BOOST_REQUIRE_NO_THROW(</div>
<div class="line"><span class="lineno">  427</span>                    ovCurve = QuantLib::ext::make_shared&lt;<a class="code hl_class" href="class_quant_ext_1_1_piecewise_optionlet_curve.html">PiecewiseOptionletCurve&lt;CubicFlat&gt;</a> &gt;(</div>
<div class="line"><span class="lineno">  428</span>                        referenceDate, helpers, calendar, bdc, dayCounter, curveVolatilityType, curveDisplacement,</div>
<div class="line"><span class="lineno">  429</span>                        flatFirstPeriod, <a class="code hl_class" href="class_quant_ext_1_1_cubic_flat.html">CubicFlat</a>(),</div>
<div class="line"><span class="lineno">  430</span>                        <a class="code hl_class" href="class_quant_ext_1_1_iterative_bootstrap.html">QuantExt::IterativeBootstrap</a>&lt;</div>
<div class="line"><span class="lineno">  431</span>                            <a class="code hl_class" href="class_quant_ext_1_1_piecewise_optionlet_curve.html">PiecewiseOptionletCurve&lt;CubicFlat, QuantExt::IterativeBootstrap&gt;::this_curve</a>&gt;(</div>
<div class="line"><span class="lineno">  432</span>                            accuracy, globalAccuracy)));</div>
<div class="line"><span class="lineno">  433</span>            }</div>
<div class="line"><span class="lineno">  434</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  435</span>        <span class="keywordflow">default</span>:</div>
<div class="line"><span class="lineno">  436</span>            BOOST_FAIL(<span class="stringliteral">&quot;Unexpected interpolation type&quot;</span>);</div>
<div class="line"><span class="lineno">  437</span>        }</div>
<div class="line"><span class="lineno">  438</span>        Handle&lt;OptionletVolatilityStructure&gt; hovs(ovCurve);</div>
<div class="line"><span class="lineno">  439</span> </div>
<div class="line"><span class="lineno">  440</span>        <span class="comment">// Price each cap floor instrument using the piecewise optionlet curve and check it against the flat NPV</span></div>
<div class="line"><span class="lineno">  441</span>        BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;The stripped values and differences at each tenor are:&quot;</span>);</div>
<div class="line"><span class="lineno">  442</span>        Real strippedNpv;</div>
<div class="line"><span class="lineno">  443</span>        <span class="keywordflow">for</span> (Size i = 0; i &lt; volatilityColumn.tenors.size(); i++) {</div>
<div class="line"><span class="lineno">  444</span> </div>
<div class="line"><span class="lineno">  445</span>            <span class="comment">// May need to update instruments type if it is being chosen automatically in the bootstrap</span></div>
<div class="line"><span class="lineno">  446</span>            <span class="keywordflow">if</span> (helperType == <a class="code hl_enumvalue" href="class_quant_ext_1_1_cap_floor_helper.html#a1d1cfd8ffb84e947f82999c682b666a7a9248ea5dc540b00adb523d1b86fc1389">CapFloorHelper::Automatic</a> &amp;&amp; quoteType != <a class="code hl_enumvalue" href="class_quant_ext_1_1_cap_floor_helper.html#aa5b3ec8bb6c730c38b87a73c11dec808aa89a292bf1c3cb8652f06442fe67c0b8">CapFloorHelper::Premium</a>) {</div>
<div class="line"><span class="lineno">  447</span>                Real volatility = volatilityColumn.volatilities[i];</div>
<div class="line"><span class="lineno">  448</span>                CapFloor::Type capFloorType =</div>
<div class="line"><span class="lineno">  449</span>                    QuantLib::ext::dynamic_pointer_cast&lt;CapFloorHelper&gt;(helpers[i])-&gt;capFloor()-&gt;type();</div>
<div class="line"><span class="lineno">  450</span>                <span class="keywordflow">if</span> (capFloorType != instruments[i]-&gt;type()) {</div>
<div class="line"><span class="lineno">  451</span>                    <span class="comment">// Need to update the instrument and the flat NPV for the test</span></div>
<div class="line"><span class="lineno">  452</span>                    instruments[i] =</div>
<div class="line"><span class="lineno">  453</span>                        MakeCapFloor(capFloorType, volatilityColumn.tenors[i], iborIndex, volatilityColumn.strike);</div>
<div class="line"><span class="lineno">  454</span>                    <span class="keywordflow">if</span> (volatilityColumn.type == ShiftedLognormal) {</div>
<div class="line"><span class="lineno">  455</span>                        instruments[i]-&gt;setPricingEngine(QuantLib::ext::make_shared&lt;BlackCapFloorEngine&gt;(</div>
<div class="line"><span class="lineno">  456</span>                            testYieldCurves.discountEonia, volatility, dayCounter, volatilityColumn.displacement));</div>
<div class="line"><span class="lineno">  457</span>                    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  458</span>                        instruments[i]-&gt;setPricingEngine(QuantLib::ext::make_shared&lt;BachelierCapFloorEngine&gt;(</div>
<div class="line"><span class="lineno">  459</span>                            testYieldCurves.discountEonia, volatility, dayCounter));</div>
<div class="line"><span class="lineno">  460</span>                    }</div>
<div class="line"><span class="lineno">  461</span>                    flatNpvs[i] = instruments[i]-&gt;NPV();</div>
<div class="line"><span class="lineno">  462</span>                }</div>
<div class="line"><span class="lineno">  463</span>            }</div>
<div class="line"><span class="lineno">  464</span> </div>
<div class="line"><span class="lineno">  465</span>            <span class="comment">// Price the instrument using the stripped optionlet structure</span></div>
<div class="line"><span class="lineno">  466</span>            <span class="keywordflow">if</span> (ovCurve-&gt;volatilityType() == ShiftedLognormal) {</div>
<div class="line"><span class="lineno">  467</span>                instruments[i]-&gt;setPricingEngine(</div>
<div class="line"><span class="lineno">  468</span>                    QuantLib::ext::make_shared&lt;BlackCapFloorEngine&gt;(testYieldCurves.discountEonia, hovs));</div>
<div class="line"><span class="lineno">  469</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  470</span>                instruments[i]-&gt;setPricingEngine(</div>
<div class="line"><span class="lineno">  471</span>                    QuantLib::ext::make_shared&lt;BachelierCapFloorEngine&gt;(testYieldCurves.discountEonia, hovs));</div>
<div class="line"><span class="lineno">  472</span>            }</div>
<div class="line"><span class="lineno">  473</span>            strippedNpv = instruments[i]-&gt;NPV();</div>
<div class="line"><span class="lineno">  474</span> </div>
<div class="line"><span class="lineno">  475</span>            BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  (Cap/Floor, Tenor, Volatility, Flat NPV, Stripped NPV, Flat - Stripped) = (&quot;</span></div>
<div class="line"><span class="lineno">  476</span>                               &lt;&lt; instruments[i]-&gt;type() &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; volatilityColumn.tenors[i] &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; fixed</div>
<div class="line"><span class="lineno">  477</span>                               &lt;&lt; setprecision(13) &lt;&lt; volatilityColumn.volatilities[i] &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; flatNpvs[i] &lt;&lt; <span class="stringliteral">&quot;, &quot;</span></div>
<div class="line"><span class="lineno">  478</span>                               &lt;&lt; strippedNpv &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; (flatNpvs[i] - strippedNpv) &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>);</div>
<div class="line"><span class="lineno">  479</span> </div>
<div class="line"><span class="lineno">  480</span>            BOOST_CHECK_SMALL(fabs(flatNpvs[i] - strippedNpv), tolerance);</div>
<div class="line"><span class="lineno">  481</span>        }</div>
<div class="line"><span class="lineno">  482</span>    }</div>
<div class="line"><span class="lineno">  483</span>}</div>
<div class="ttc" id="aclass_quant_ext_1_1_cap_floor_helper_html_a1d1cfd8ffb84e947f82999c682b666a7a9248ea5dc540b00adb523d1b86fc1389"><div class="ttname"><a href="class_quant_ext_1_1_cap_floor_helper.html#a1d1cfd8ffb84e947f82999c682b666a7a9248ea5dc540b00adb523d1b86fc1389">QuantExt::CapFloorHelper::Automatic</a></div><div class="ttdeci">@ Automatic</div><div class="ttdef"><b>Definition:</b> <a href="capfloorhelper_8hpp_source.html#l00045">capfloorhelper.hpp:45</a></div></div>
<div class="ttc" id="aclass_quant_ext_1_1_cap_floor_helper_html_a1d1cfd8ffb84e947f82999c682b666a7a94e95e4b8360855608dfad0b1f43a301"><div class="ttname"><a href="class_quant_ext_1_1_cap_floor_helper.html#a1d1cfd8ffb84e947f82999c682b666a7a94e95e4b8360855608dfad0b1f43a301">QuantExt::CapFloorHelper::Floor</a></div><div class="ttdeci">@ Floor</div><div class="ttdef"><b>Definition:</b> <a href="capfloorhelper_8hpp_source.html#l00045">capfloorhelper.hpp:45</a></div></div>
<div class="ttc" id="aclass_quant_ext_1_1_cap_floor_helper_html_aa5b3ec8bb6c730c38b87a73c11dec808aa89a292bf1c3cb8652f06442fe67c0b8"><div class="ttname"><a href="class_quant_ext_1_1_cap_floor_helper.html#aa5b3ec8bb6c730c38b87a73c11dec808aa89a292bf1c3cb8652f06442fe67c0b8">QuantExt::CapFloorHelper::Premium</a></div><div class="ttdeci">@ Premium</div><div class="ttdef"><b>Definition:</b> <a href="capfloorhelper_8hpp_source.html#l00048">capfloorhelper.hpp:48</a></div></div>
<div class="ttc" id="aclass_quant_ext_1_1_cap_floor_helper_html_aa5b3ec8bb6c730c38b87a73c11dec808adab9ccfeb3c1dbe934be59599c8d7372"><div class="ttname"><a href="class_quant_ext_1_1_cap_floor_helper.html#aa5b3ec8bb6c730c38b87a73c11dec808adab9ccfeb3c1dbe934be59599c8d7372">QuantExt::CapFloorHelper::Volatility</a></div><div class="ttdeci">@ Volatility</div><div class="ttdef"><b>Definition:</b> <a href="capfloorhelper_8hpp_source.html#l00048">capfloorhelper.hpp:48</a></div></div>
<div class="ttc" id="aclass_quant_ext_1_1_cubic_flat_html"><div class="ttname"><a href="class_quant_ext_1_1_cubic_flat.html">QuantExt::CubicFlat</a></div><div class="ttdoc">Cubic interpolation and flat extrapolation factory and traits.</div><div class="ttdef"><b>Definition:</b> <a href="flatextrapolation_8hpp_source.html#l00127">flatextrapolation.hpp:127</a></div></div>
<div class="ttc" id="aclass_quant_ext_1_1_iterative_bootstrap_html"><div class="ttname"><a href="class_quant_ext_1_1_iterative_bootstrap.html">QuantExt::IterativeBootstrap</a></div><div class="ttdef"><b>Definition:</b> <a href="iterativebootstrap_8hpp_source.html#l00077">iterativebootstrap.hpp:77</a></div></div>
<div class="ttc" id="aclass_quant_ext_1_1_piecewise_optionlet_curve_html"><div class="ttname"><a href="class_quant_ext_1_1_piecewise_optionlet_curve.html">QuantExt::PiecewiseOptionletCurve</a></div><div class="ttdef"><b>Definition:</b> <a href="piecewiseoptionletcurve_8hpp_source.html#l00101">piecewiseoptionletcurve.hpp:101</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ae30a90cc81914f1079d9583d81cad7c1" name="ae30a90cc81914f1079d9583d81cad7c1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae30a90cc81914f1079d9583d81cad7c1">&#9670;&#160;</a></span>BOOST_DATA_TEST_CASE_F() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">BOOST_DATA_TEST_CASE_F </td>
          <td>(</td>
          <td class="paramtype">CommonVars&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">testCachedValues&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bdata::make(interpolationTypesCached) *bdata::make(flatFirstPeriodValues)&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">interpolationType&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">flatFirstPeriod&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="piecewiseoptionletcurve_8cpp_source.html#l00485">485</a> of file <a class="el" href="piecewiseoptionletcurve_8cpp_source.html">piecewiseoptionletcurve.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  487</span>                                        {</div>
<div class="line"><span class="lineno">  488</span> </div>
<div class="line"><span class="lineno">  489</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Testing stripping of single strike column against cached values&quot;</span>);</div>
<div class="line"><span class="lineno">  490</span> </div>
<div class="line"><span class="lineno">  491</span>    <a class="code hl_enumeration" href="class_quant_ext_1_1_cap_floor_helper.html#a1d1cfd8ffb84e947f82999c682b666a7">CapFloorHelper::Type</a> helperType = <a class="code hl_enumvalue" href="class_quant_ext_1_1_cap_floor_helper.html#a1d1cfd8ffb84e947f82999c682b666a7a9248ea5dc540b00adb523d1b86fc1389">CapFloorHelper::Automatic</a>;</div>
<div class="line"><span class="lineno">  492</span>    <a class="code hl_enumeration" href="class_quant_ext_1_1_cap_floor_helper.html#aa5b3ec8bb6c730c38b87a73c11dec808">CapFloorHelper::QuoteType</a> quoteType = <a class="code hl_enumvalue" href="class_quant_ext_1_1_cap_floor_helper.html#aa5b3ec8bb6c730c38b87a73c11dec808adab9ccfeb3c1dbe934be59599c8d7372">CapFloorHelper::Volatility</a>;</div>
<div class="line"><span class="lineno">  493</span> </div>
<div class="line"><span class="lineno">  494</span>    <span class="comment">// Use EUR cap floor test volatility data from file test/capfloormarketdata.hpp</span></div>
<div class="line"><span class="lineno">  495</span>    <span class="comment">// Take the highest strike column of the normal volatility matrix</span></div>
<div class="line"><span class="lineno">  496</span>    <a class="code hl_struct" href="struct_quant_ext_1_1_cap_floor_volatility_e_u_r.html">CapFloorVolatilityEUR</a> testVols;</div>
<div class="line"><span class="lineno">  497</span>    vector&lt;Period&gt; tenors = testVols.<a class="code hl_variable" href="struct_quant_ext_1_1_cap_floor_volatility_e_u_r.html#a82dffcdd30530c085f4868043cdcc73c">tenors</a>;</div>
<div class="line"><span class="lineno">  498</span>    vector&lt;Real&gt; volatilities(tenors.size());</div>
<div class="line"><span class="lineno">  499</span>    Size strikeIdx = testVols.<a class="code hl_variable" href="struct_quant_ext_1_1_cap_floor_volatility_e_u_r.html#a0a8698dccd59fac3c310ef17677d853c">strikes</a>.size() - 1;</div>
<div class="line"><span class="lineno">  500</span>    Rate strike = testVols.<a class="code hl_variable" href="struct_quant_ext_1_1_cap_floor_volatility_e_u_r.html#a0a8698dccd59fac3c310ef17677d853c">strikes</a>[strikeIdx];</div>
<div class="line"><span class="lineno">  501</span>    <span class="keywordflow">for</span> (Size i = 0; i &lt; tenors.size(); i++) {</div>
<div class="line"><span class="lineno">  502</span>        volatilities[i] = testVols.<a class="code hl_variable" href="struct_quant_ext_1_1_cap_floor_volatility_e_u_r.html#a72d55a8211eccc9651dfa0534997eb5f">nVols</a>[i][strikeIdx];</div>
<div class="line"><span class="lineno">  503</span>    }</div>
<div class="line"><span class="lineno">  504</span>    VolatilityType volatilityType = Normal;</div>
<div class="line"><span class="lineno">  505</span>    Real displacement = 0.0;</div>
<div class="line"><span class="lineno">  506</span> </div>
<div class="line"><span class="lineno">  507</span>    <span class="comment">// Make first tenor 18M highlight differences introduced by flatFirstPeriod setting.</span></div>
<div class="line"><span class="lineno">  508</span>    <span class="comment">// With first tenor = 1Y and index tenor = 6M, we were not seeing a difference.</span></div>
<div class="line"><span class="lineno">  509</span>    tenors[0] = 18 * Months;</div>
<div class="line"><span class="lineno">  510</span> </div>
<div class="line"><span class="lineno">  511</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Test inputs are:&quot;</span>);</div>
<div class="line"><span class="lineno">  512</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  Cap floor helper type: &quot;</span> &lt;&lt; helperType);</div>
<div class="line"><span class="lineno">  513</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  Cap floor strike: &quot;</span> &lt;&lt; strike);</div>
<div class="line"><span class="lineno">  514</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  Quote type: &quot;</span> &lt;&lt; quoteType);</div>
<div class="line"><span class="lineno">  515</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  Quote volatility type: &quot;</span> &lt;&lt; volatilityType);</div>
<div class="line"><span class="lineno">  516</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  Quote displacement: &quot;</span> &lt;&lt; displacement);</div>
<div class="line"><span class="lineno">  517</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  Interpolation type: &quot;</span> &lt;&lt; to_string(interpolationType));</div>
<div class="line"><span class="lineno">  518</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;  Flat first period: &quot;</span> &lt;&lt; boolalpha &lt;&lt; flatFirstPeriod);</div>
<div class="line"><span class="lineno">  519</span> </div>
<div class="line"><span class="lineno">  520</span>    <span class="comment">// Form the cap floor helper instrument for each tenor in the strike column</span></div>
<div class="line"><span class="lineno">  521</span>    vector&lt;QuantLib::ext::shared_ptr&lt;helper&gt; &gt; helpers(tenors.size());</div>
<div class="line"><span class="lineno">  522</span>    <span class="keywordflow">for</span> (Size i = 0; i &lt; tenors.size(); i++) {</div>
<div class="line"><span class="lineno">  523</span>        Handle&lt;Quote&gt; quote(QuantLib::ext::make_shared&lt;SimpleQuote&gt;(volatilities[i]));</div>
<div class="line"><span class="lineno">  524</span>        helpers[i] = QuantLib::ext::make_shared&lt;CapFloorHelper&gt;(helperType, tenors[i], strike, quote, iborIndex,</div>
<div class="line"><span class="lineno">  525</span>                                                        testYieldCurves.discountEonia, <span class="keyword">true</span>, Date(), quoteType,</div>
<div class="line"><span class="lineno">  526</span>                                                        volatilityType, displacement);</div>
<div class="line"><span class="lineno">  527</span>    }</div>
<div class="line"><span class="lineno">  528</span> </div>
<div class="line"><span class="lineno">  529</span>    <span class="comment">// Create the piecewise optionlet curve, with the given interpolation type.</span></div>
<div class="line"><span class="lineno">  530</span>    <span class="comment">// Store the nodes of this optionlet curve to compare with cached values</span></div>
<div class="line"><span class="lineno">  531</span>    VolatilityType curveVolatilityType = Normal;</div>
<div class="line"><span class="lineno">  532</span>    Real curveDisplacement = 0.0;</div>
<div class="line"><span class="lineno">  533</span>    QuantLib::ext::shared_ptr&lt;OptionletVolatilityStructure&gt; ovs;</div>
<div class="line"><span class="lineno">  534</span>    vector&lt;pair&lt;Date, Real&gt; &gt; curveNodes;</div>
<div class="line"><span class="lineno">  535</span>    <span class="keywordflow">switch</span> (interpolationType.which()) {</div>
<div class="line"><span class="lineno">  536</span>    <span class="keywordflow">case</span> 0: {</div>
<div class="line"><span class="lineno">  537</span>        BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Using Linear interpolation&quot;</span>);</div>
<div class="line"><span class="lineno">  538</span>        QuantLib::ext::shared_ptr&lt;PiecewiseOptionletCurve&lt;Linear&gt; &gt; ovCurve =</div>
<div class="line"><span class="lineno">  539</span>            QuantLib::ext::make_shared&lt;PiecewiseOptionletCurve&lt;Linear&gt; &gt;(referenceDate, helpers, calendar, bdc, dayCounter,</div>
<div class="line"><span class="lineno">  540</span>                                                                 curveVolatilityType, curveDisplacement,</div>
<div class="line"><span class="lineno">  541</span>                                                                 flatFirstPeriod);</div>
<div class="line"><span class="lineno">  542</span>        curveNodes = ovCurve-&gt;nodes();</div>
<div class="line"><span class="lineno">  543</span>        ovs = ovCurve;</div>
<div class="line"><span class="lineno">  544</span>    } <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  545</span>    <span class="keywordflow">case</span> 1: {</div>
<div class="line"><span class="lineno">  546</span>        BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Using BackwardFlat interpolation&quot;</span>);</div>
<div class="line"><span class="lineno">  547</span>        QuantLib::ext::shared_ptr&lt;PiecewiseOptionletCurve&lt;BackwardFlat&gt; &gt; ovCurve =</div>
<div class="line"><span class="lineno">  548</span>            QuantLib::ext::make_shared&lt;PiecewiseOptionletCurve&lt;BackwardFlat&gt; &gt;(referenceDate, helpers, calendar, bdc,</div>
<div class="line"><span class="lineno">  549</span>                                                                       dayCounter, curveVolatilityType,</div>
<div class="line"><span class="lineno">  550</span>                                                                       curveDisplacement, flatFirstPeriod);</div>
<div class="line"><span class="lineno">  551</span>        curveNodes = ovCurve-&gt;nodes();</div>
<div class="line"><span class="lineno">  552</span>        ovs = ovCurve;</div>
<div class="line"><span class="lineno">  553</span>    } <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  554</span>    <span class="keywordflow">case</span> 2: {</div>
<div class="line"><span class="lineno">  555</span>        BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;Using LinearFlat interpolation&quot;</span>);</div>
<div class="line"><span class="lineno">  556</span>        QuantLib::ext::shared_ptr&lt;PiecewiseOptionletCurve&lt;LinearFlat&gt; &gt; ovCurve =</div>
<div class="line"><span class="lineno">  557</span>            QuantLib::ext::make_shared&lt;PiecewiseOptionletCurve&lt;LinearFlat&gt; &gt;(referenceDate, helpers, calendar, bdc, dayCounter,</div>
<div class="line"><span class="lineno">  558</span>                                                                     curveVolatilityType, curveDisplacement,</div>
<div class="line"><span class="lineno">  559</span>                                                                     flatFirstPeriod);</div>
<div class="line"><span class="lineno">  560</span>        curveNodes = ovCurve-&gt;nodes();</div>
<div class="line"><span class="lineno">  561</span>        ovs = ovCurve;</div>
<div class="line"><span class="lineno">  562</span>    } <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  563</span>    <span class="keywordflow">default</span>:</div>
<div class="line"><span class="lineno">  564</span>        BOOST_FAIL(<span class="stringliteral">&quot;Unexpected interpolation type&quot;</span>);</div>
<div class="line"><span class="lineno">  565</span>    }</div>
<div class="line"><span class="lineno">  566</span> </div>
<div class="line"><span class="lineno">  567</span>    <span class="comment">// Get the key for the cached results for the current test</span></div>
<div class="line"><span class="lineno">  568</span>    Size key = 2 * interpolationType.which() + <span class="keyword">static_cast&lt;</span>Size<span class="keyword">&gt;</span>(flatFirstPeriod);</div>
<div class="line"><span class="lineno">  569</span> </div>
<div class="line"><span class="lineno">  570</span>    <span class="comment">// Check stripped optionlet volatilities against cached values</span></div>
<div class="line"><span class="lineno">  571</span>    BOOST_REQUIRE_EQUAL(curveNodes.size(), cachedDates.size());</div>
<div class="line"><span class="lineno">  572</span>    BOOST_REQUIRE(cachedValues.count(key) == 1);</div>
<div class="line"><span class="lineno">  573</span>    BOOST_REQUIRE_EQUAL(curveNodes.size(), cachedValues.at(key).size());</div>
<div class="line"><span class="lineno">  574</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;node_date,node_vol&quot;</span>);</div>
<div class="line"><span class="lineno">  575</span>    <span class="keywordflow">for</span> (Size i = 0; i &lt; curveNodes.size(); i++) {</div>
<div class="line"><span class="lineno">  576</span>        <span class="comment">// Check the date</span></div>
<div class="line"><span class="lineno">  577</span>        BOOST_CHECK_EQUAL(curveNodes[i].first, cachedDates[i]);</div>
<div class="line"><span class="lineno">  578</span>        <span class="comment">// Check the value</span></div>
<div class="line"><span class="lineno">  579</span>        BOOST_CHECK_SMALL(fabs(curveNodes[i].second - cachedValues.at(key)[i]), accuracy);</div>
<div class="line"><span class="lineno">  580</span>        <span class="comment">// Print out the curve</span></div>
<div class="line"><span class="lineno">  581</span>        BOOST_TEST_MESSAGE(io::iso_date(curveNodes[i].first)</div>
<div class="line"><span class="lineno">  582</span>                           &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; fixed &lt;&lt; setprecision(12) &lt;&lt; curveNodes[i].second);</div>
<div class="line"><span class="lineno">  583</span>    }</div>
<div class="line"><span class="lineno">  584</span> </div>
<div class="line"><span class="lineno">  585</span>    <span class="comment">// Check stripped optionlet volatilities on non-node dates against cached values</span></div>
<div class="line"><span class="lineno">  586</span>    BOOST_REQUIRE(cachedNonNodeValues.count(key) == 1);</div>
<div class="line"><span class="lineno">  587</span>    BOOST_TEST_MESSAGE(<span class="stringliteral">&quot;date,vol,cached_vol,diff&quot;</span>);</div>
<div class="line"><span class="lineno">  588</span>    <span class="keywordflow">for</span> (Size i = 0; i &lt; cachedNonNodeDates.size(); i++) {</div>
<div class="line"><span class="lineno">  589</span>        Date d = cachedNonNodeDates[i];</div>
<div class="line"><span class="lineno">  590</span> </div>
<div class="line"><span class="lineno">  591</span>        <span class="comment">// The last date has been picked past the maximum curve date to check extrapolation. Check that we get an</span></div>
<div class="line"><span class="lineno">  592</span>        <span class="comment">// error and then turn on extrapolation.</span></div>
<div class="line"><span class="lineno">  593</span>        <span class="keywordflow">if</span> (i == cachedNonNodeDates.size() - 1) {</div>
<div class="line"><span class="lineno">  594</span>            BOOST_CHECK_THROW(ovs-&gt;volatility(d, strike), Error);</div>
<div class="line"><span class="lineno">  595</span>            ovs-&gt;enableExtrapolation();</div>
<div class="line"><span class="lineno">  596</span>        }</div>
<div class="line"><span class="lineno">  597</span> </div>
<div class="line"><span class="lineno">  598</span>        Volatility vol = ovs-&gt;volatility(d, strike);</div>
<div class="line"><span class="lineno">  599</span>        Volatility cachedVol = cachedNonNodeValues.at(key)[i];</div>
<div class="line"><span class="lineno">  600</span>        Volatility diff = fabs(vol - cachedVol);</div>
<div class="line"><span class="lineno">  601</span>        <span class="comment">// Check the value</span></div>
<div class="line"><span class="lineno">  602</span>        BOOST_CHECK_SMALL(diff, accuracy);</div>
<div class="line"><span class="lineno">  603</span>        <span class="comment">// Print out the curve</span></div>
<div class="line"><span class="lineno">  604</span>        BOOST_TEST_MESSAGE(io::iso_date(d)</div>
<div class="line"><span class="lineno">  605</span>                           &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; fixed &lt;&lt; setprecision(12) &lt;&lt; vol &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; cachedVol &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; diff);</div>
<div class="line"><span class="lineno">  606</span> </div>
<div class="line"><span class="lineno">  607</span>        <span class="comment">// The strike should not matter so check that the same test passes above and below the strike</span></div>
<div class="line"><span class="lineno">  608</span>        Real shift = 0.0010;</div>
<div class="line"><span class="lineno">  609</span>        diff = fabs(ovs-&gt;volatility(d, strike - shift) - cachedVol);</div>
<div class="line"><span class="lineno">  610</span>        BOOST_CHECK_SMALL(diff, accuracy);</div>
<div class="line"><span class="lineno">  611</span>        diff = fabs(ovs-&gt;volatility(d, strike + shift) - cachedVol);</div>
<div class="line"><span class="lineno">  612</span>        BOOST_CHECK_SMALL(diff, accuracy);</div>
<div class="line"><span class="lineno">  613</span>    }</div>
<div class="line"><span class="lineno">  614</span>}</div>
<div class="ttc" id="aclass_quant_ext_1_1_cap_floor_helper_html_a1d1cfd8ffb84e947f82999c682b666a7"><div class="ttname"><a href="class_quant_ext_1_1_cap_floor_helper.html#a1d1cfd8ffb84e947f82999c682b666a7">QuantExt::CapFloorHelper::Type</a></div><div class="ttdeci">Type</div><div class="ttdef"><b>Definition:</b> <a href="capfloorhelper_8hpp_source.html#l00045">capfloorhelper.hpp:45</a></div></div>
<div class="ttc" id="aclass_quant_ext_1_1_cap_floor_helper_html_aa5b3ec8bb6c730c38b87a73c11dec808"><div class="ttname"><a href="class_quant_ext_1_1_cap_floor_helper.html#aa5b3ec8bb6c730c38b87a73c11dec808">QuantExt::CapFloorHelper::QuoteType</a></div><div class="ttdeci">QuoteType</div><div class="ttdoc">Enum to indicate the type of the quote provided with the CapFloorHelper.</div><div class="ttdef"><b>Definition:</b> <a href="capfloorhelper_8hpp_source.html#l00048">capfloorhelper.hpp:48</a></div></div>
<div class="ttc" id="astruct_quant_ext_1_1_cap_floor_volatility_e_u_r_html"><div class="ttname"><a href="struct_quant_ext_1_1_cap_floor_volatility_e_u_r.html">QuantExt::CapFloorVolatilityEUR</a></div><div class="ttdef"><b>Definition:</b> <a href="capfloormarketdata_8hpp_source.html#l00039">capfloormarketdata.hpp:39</a></div></div>
<div class="ttc" id="astruct_quant_ext_1_1_cap_floor_volatility_e_u_r_html_a0a8698dccd59fac3c310ef17677d853c"><div class="ttname"><a href="struct_quant_ext_1_1_cap_floor_volatility_e_u_r.html#a0a8698dccd59fac3c310ef17677d853c">QuantExt::CapFloorVolatilityEUR::strikes</a></div><div class="ttdeci">vector&lt; Rate &gt; strikes</div><div class="ttdef"><b>Definition:</b> <a href="capfloormarketdata_8hpp_source.html#l00185">capfloormarketdata.hpp:185</a></div></div>
<div class="ttc" id="astruct_quant_ext_1_1_cap_floor_volatility_e_u_r_html_a72d55a8211eccc9651dfa0534997eb5f"><div class="ttname"><a href="struct_quant_ext_1_1_cap_floor_volatility_e_u_r.html#a72d55a8211eccc9651dfa0534997eb5f">QuantExt::CapFloorVolatilityEUR::nVols</a></div><div class="ttdeci">Matrix nVols</div><div class="ttdef"><b>Definition:</b> <a href="capfloormarketdata_8hpp_source.html#l00186">capfloormarketdata.hpp:186</a></div></div>
<div class="ttc" id="astruct_quant_ext_1_1_cap_floor_volatility_e_u_r_html_a82dffcdd30530c085f4868043cdcc73c"><div class="ttname"><a href="struct_quant_ext_1_1_cap_floor_volatility_e_u_r.html#a82dffcdd30530c085f4868043cdcc73c">QuantExt::CapFloorVolatilityEUR::tenors</a></div><div class="ttdeci">vector&lt; Period &gt; tenors</div><div class="ttdef"><b>Definition:</b> <a href="capfloormarketdata_8hpp_source.html#l00184">capfloormarketdata.hpp:184</a></div></div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- HTML footer for doxygen 1.8.9.1-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by <a href="http://www.doxygen.org/index.html">Doxygen</a>
1.9.5
</small></address>
</body>
</html>
